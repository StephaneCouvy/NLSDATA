<!DOCTYPE html>

<html lang="fr" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>nlsdata.oci_lh2_bronze.oci_lh2_bronze &#8212; Documentation NLSDATA 1.0.0</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css?v=12dfc556" />
    <script src="../../../_static/documentation_options.js?v=05dadb3a"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/translations.js?v=041d0952"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Recherche" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Code source de nlsdata.oci_lh2_bronze.oci_lh2_bronze</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">os.path</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">nlstools.config_settings</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">nlstools.tool_kits</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">nlsdb.dbwrapper_factory</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">nlsfilestorage.filestorage_wrapper_factory</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">nlsfilestorage.filestorage_wrapper.abs_filestorage</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">nlsdata.nlsdata_utils</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">EXPLOIT_ARG_LOADING_TABLE</span> <span class="o">=</span> <span class="s1">&#39;l&#39;</span>
<span class="n">EXPLOIT_ARG_LOG_TABLE</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span>
<span class="n">EXPLOIT_ARG_RELOAD_ON_ERROR_INTERVAL</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span>
<span class="n">EXPLOIT_ARG_NOT_DROP_TEMP_RUNNING_LOADING_TABLE</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span>
<span class="n">EXPLOIT_ARG_QUERY</span> <span class="o">=</span> <span class="s1">&#39;q&#39;</span>

<span class="n">ZOMBIES_TABLE_NAME</span> <span class="o">=</span> <span class="s1">&#39;ZOMBIES&#39;</span>
<span class="c1">#RESET_DATE_LASTUPDATE = datetime.strptime(&#39;2018-01-01 00:00:00&#39;, &#39;%Y-%m-%d %H:%M:%S&#39;)</span>

<span class="n">FILESTORAGE_BRONZE_BUCKET_DEBUG</span> <span class="o">=</span> <span class="s1">&#39;BRONZE_BUCKET_DEBUG&#39;</span>
<span class="n">FILESTORAGE_BRONZE_BUCKET</span> <span class="o">=</span> <span class="s1">&#39;BRONZE_BUCKET&#39;</span>

<span class="n">PARQUET_IDX_DIGITS</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">PANDAS_CHUNKSIZE</span> <span class="o">=</span> <span class="mi">100000</span>
<span class="c1"># Variables could be redefined by json config file</span>
<span class="n">DB_ARRAYSIZE</span> <span class="o">=</span> <span class="mi">50000</span>
<span class="n">SQL_READMODE</span> <span class="o">=</span> <span class="s2">&quot;DBCURSOR&quot;</span> <span class="c1">#CURSORDB / PANDAS</span>
<span class="n">PARQUET_FILE_EXTENSION</span> <span class="o">=</span> <span class="s2">&quot;.parquet&quot;</span>

<span class="n">DBFACTORY</span> <span class="o">=</span> <span class="n">NLSDbFactory</span><span class="p">()</span>
<span class="n">FILESTORAGEFACTORY</span> <span class="o">=</span> <span class="n">NLSFileStorageFactory</span><span class="p">()</span>

<span class="n">DICT_STATUS_CODE</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;completed&#39;</span><span class="p">:</span><span class="s1">&#39;COMPLETED&#39;</span><span class="p">,</span><span class="s1">&#39;error&#39;</span><span class="p">:</span><span class="s1">&#39;ERROR&#39;</span><span class="p">,</span><span class="s1">&#39;data_fetched&#39;</span><span class="p">:</span><span class="s1">&#39;FETCHED&#39;</span><span class="p">,</span><span class="s1">&#39;parquet_sent&#39;</span><span class="p">:</span><span class="s1">&#39;UPLOADED&#39;</span><span class="p">,</span><span class="s1">&#39;bronze_updated&#39;</span><span class="p">:</span><span class="s1">&#39;UPDATED&#39;</span><span class="p">,</span><span class="s2">&quot;fetching&quot;</span><span class="p">:</span><span class="s2">&quot;FETCHING&quot;</span><span class="p">}</span>
<span class="n">SOURCE_PROPERTIES_SYNONYMS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SRC_TYPE&#39;</span><span class="p">:</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;SRC_NAME&#39;</span><span class="p">:</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;SRC_ORIGIN_NAME&#39;</span><span class="p">:</span> <span class="s1">&#39;schema&#39;</span><span class="p">,</span> <span class="s1">&#39;SRC_OBJECT_NAME&#39;</span><span class="p">:</span> <span class="s1">&#39;table&#39;</span><span class="p">,</span> <span class="s1">&#39;SRC_OBJECT_CONSTRAINT&#39;</span><span class="p">:</span> <span class="s1">&#39;table_constraint&#39;</span><span class="p">,</span> <span class="s1">&#39;SRC_FLAG_ACTIVE&#39;</span><span class="p">:</span> <span class="s1">&#39;active&#39;</span><span class="p">,</span> <span class="s1">&#39;SRC_FLAG_INCR&#39;</span><span class="p">:</span> <span class="s1">&#39;incremental&#39;</span><span class="p">,</span> <span class="s1">&#39;SRC_DATE_CONSTRAINT&#39;</span><span class="p">:</span> <span class="s1">&#39;date_criteria&#39;</span><span class="p">,</span> <span class="s1">&#39;SRC_DATE_LASTUPDATE&#39;</span><span class="p">:</span> <span class="s1">&#39;last_update&#39;</span><span class="p">,</span> <span class="s1">&#39;FORCE_ENCODE&#39;</span><span class="p">:</span> <span class="s1">&#39;force_encode&#39;</span><span class="p">,</span> <span class="s1">&#39;BRONZE_BIS_PK&#39;</span><span class="p">:</span><span class="s1">&#39;bronze_bis_pk&#39;</span><span class="p">,</span><span class="s1">&#39;BRONZE_POST_PROCEDURE&#39;</span><span class="p">:</span> <span class="s1">&#39;bronze_post_proc&#39;</span><span class="p">,</span> <span class="s1">&#39;BRONZE_POST_PROCEDURE_ARGS&#39;</span><span class="p">:</span> <span class="s1">&#39;bronze_post_proc_args&#39;</span><span class="p">,</span><span class="s1">&#39;BRONZE_TABLE_NAME&#39;</span><span class="p">:</span><span class="s1">&#39;bronze_table_name&#39;</span><span class="p">,</span><span class="s1">&#39;BRONZE_LASTUPLOADED_PARQUET&#39;</span><span class="p">:</span><span class="s1">&#39;lastuploaded_parquet&#39;</span><span class="p">,</span><span class="s1">&#39;SRC_TABLE_IDX&#39;</span><span class="p">:</span><span class="s1">&#39;source_table_indexes&#39;</span><span class="p">,</span><span class="s1">&#39;RESET_LASTUPDATE&#39;</span><span class="p">:</span><span class="s1">&#39;reset_lastupdate&#39;</span><span class="p">,</span><span class="s1">&#39;BRONZE_UPDATE&#39;</span><span class="p">:</span><span class="s1">&#39;bronze_update&#39;</span><span class="p">}</span>
<span class="n">INVERTED_SOURCE_PROPERTIES_SYNONYMS</span> <span class="o">=</span> <span class="p">{</span><span class="n">value</span><span class="p">:</span> <span class="n">key</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">SOURCE_PROPERTIES_SYNONYMS</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<span class="n">SourceProperties</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;SourceProperties&#39;</span><span class="p">,</span><span class="nb">list</span><span class="p">(</span><span class="n">SOURCE_PROPERTIES_SYNONYMS</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

<span class="n">EXTERNAL_TABLE_PARTITION_SYNONYMS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;FETCH_YEAR&#39;</span><span class="p">:</span><span class="s1">&#39;year&#39;</span><span class="p">,</span><span class="s1">&#39;FETCH_MONTH&#39;</span><span class="p">:</span><span class="s1">&#39;month&#39;</span><span class="p">,</span><span class="s1">&#39;FETCH_DAY&#39;</span><span class="p">:</span><span class="s1">&#39;day&#39;</span><span class="p">}</span>
<span class="n">INVERTED_EXTERNAL_TABLE_PARTITION_SYNONYMS</span> <span class="o">=</span> <span class="p">{</span><span class="n">value</span><span class="p">:</span> <span class="n">key</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">EXTERNAL_TABLE_PARTITION_SYNONYMS</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<span class="n">ExternalTablePartitionsProperties</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;ExternalTablePartitionsProperties&#39;</span><span class="p">,</span><span class="nb">list</span><span class="p">(</span><span class="n">EXTERNAL_TABLE_PARTITION_SYNONYMS</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

<span class="c1"># SourceProperties namedtuple is set into Exploit __init__, based on fields of table used to list sources</span>

<span class="n">BronzeProperties</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;BronzeProperties&#39;</span><span class="p">,[</span><span class="s1">&#39;environment&#39;</span><span class="p">,</span><span class="s1">&#39;schema&#39;</span><span class="p">,</span><span class="s1">&#39;table&#39;</span><span class="p">,</span><span class="s1">&#39;bucket&#39;</span><span class="p">,</span><span class="s1">&#39;bucket_filepath&#39;</span><span class="p">,</span><span class="s1">&#39;parquet_template&#39;</span><span class="p">])</span>

<div class="viewcode-block" id="BronzeConfig">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeConfig">[docs]</a>
<span class="k">class</span> <span class="nc">BronzeConfig</span><span class="p">():</span>
    <span class="c1">#Define configuration envrionment parameters to execute.</span>
    <span class="c1">#Mainly extract parameters from json configuration_file</span>
    <span class="c1">#Provide a generic method to get an oracledb connection, depending on database options defined into json</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">configuration_file</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configuration_file</span> <span class="o">=</span> <span class="n">path_replace_tilde_with_home</span><span class="p">(</span><span class="n">configuration_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">get_parser_config_settings</span><span class="p">(</span><span class="s2">&quot;options&quot;</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration_file</span><span class="p">,</span><span class="s2">&quot;options&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">duckdb_settings</span> <span class="o">=</span> <span class="n">get_parser_config_settings</span><span class="p">(</span><span class="s2">&quot;duckdb_settings&quot;</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration_file</span><span class="p">,</span><span class="s2">&quot;duckdb_settings&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">db_arraysize</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="k">global</span> <span class="n">DB_ARRAYSIZE</span>
            <span class="n">DB_ARRAYSIZE</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">db_arraysize</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sql_readmode</span><span class="p">:</span>
            <span class="k">global</span> <span class="n">SQL_READMODE</span>
            <span class="n">SQL_READMODE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sql_readmode</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">environment</span> <span class="o">==</span> <span class="s2">&quot;DEBUG&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oci_settings</span> <span class="o">=</span> <span class="n">get_parser_config_settings</span><span class="p">(</span><span class="s2">&quot;filestorage&quot;</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration_file</span><span class="p">,</span><span class="n">FILESTORAGE_BRONZE_BUCKET_DEBUG</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oci_settings</span> <span class="o">=</span> <span class="n">get_parser_config_settings</span><span class="p">(</span><span class="s2">&quot;filestorage&quot;</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration_file</span><span class="p">,</span><span class="n">FILESTORAGE_BRONZE_BUCKET</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">rootdir</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rootdir</span> <span class="o">=</span> <span class="n">path_replace_tilde_with_home</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">rootdir</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rootdir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rootdir</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="c1"># Create a temporary directory if it doesn&#39;t exist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">tempdir</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="p">)</span>

        <span class="c1"># return absolute Path for log file.</span>
        <span class="c1"># if full path is not specified, then add workging dir ahead</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_options</span><span class="p">()</span><span class="o">.</span><span class="n">verboselogfile</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verboselogfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_tempdir</span><span class="p">(),</span><span class="bp">self</span><span class="o">.</span><span class="n">get_options</span><span class="p">()</span><span class="o">.</span><span class="n">verboselogfile</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verboselogfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_options</span><span class="p">()</span><span class="o">.</span><span class="n">verboselogfile</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">verboselevel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_options</span><span class="p">()</span><span class="o">.</span><span class="n">verbose_level</span>

<div class="viewcode-block" id="BronzeConfig.get_configuration_file">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeConfig.get_configuration_file">[docs]</a>
    <span class="k">def</span> <span class="nf">get_configuration_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">configuration_file</span></div>


<div class="viewcode-block" id="BronzeConfig.get_options">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeConfig.get_options">[docs]</a>
    <span class="k">def</span> <span class="nf">get_options</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span></div>


<div class="viewcode-block" id="BronzeConfig.get_duckdb_settings">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeConfig.get_duckdb_settings">[docs]</a>
    <span class="k">def</span> <span class="nf">get_duckdb_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">duckdb_settings</span></div>


<div class="viewcode-block" id="BronzeConfig.get_oci_settings">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeConfig.get_oci_settings">[docs]</a>
    <span class="k">def</span> <span class="nf">get_oci_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">oci_settings</span></div>

            
<div class="viewcode-block" id="BronzeConfig.isdebugmode">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeConfig.isdebugmode">[docs]</a>
    <span class="k">def</span> <span class="nf">isdebugmode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span></div>


<div class="viewcode-block" id="BronzeConfig.get_rootdir">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeConfig.get_rootdir">[docs]</a>
    <span class="k">def</span> <span class="nf">get_rootdir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rootdir</span></div>

<div class="viewcode-block" id="BronzeConfig.get_tempdir">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeConfig.get_tempdir">[docs]</a>
    <span class="k">def</span> <span class="nf">get_tempdir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span></div>

<div class="viewcode-block" id="BronzeConfig.get_verboselogfile">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeConfig.get_verboselogfile">[docs]</a>
    <span class="k">def</span> <span class="nf">get_verboselogfile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">verboselogfile</span></div>

<div class="viewcode-block" id="BronzeConfig.get_verboselevel">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeConfig.get_verboselevel">[docs]</a>
    <span class="k">def</span> <span class="nf">get_verboselevel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">verboselevel</span></div>
</div>


<div class="viewcode-block" id="BronzeLogger">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeLogger">[docs]</a>
<span class="k">class</span> <span class="nc">BronzeLogger</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pBronze_config</span><span class="p">,</span><span class="n">p_verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger_linked_bronze_source</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger_linked_bronze_config</span> <span class="o">=</span> <span class="n">pBronze_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">p_verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger_oracledb_connection</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger_linked_bronze_config</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger_env</span> <span class="o">=</span> <span class="n">pBronze_config</span><span class="o">.</span><span class="n">get_options</span><span class="p">()</span><span class="o">.</span><span class="n">environment</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger_table_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger_linked_bronze_config</span><span class="o">.</span><span class="n">get_options</span><span class="p">()</span><span class="o">.</span><span class="n">log_table_prefix</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger_linked_bronze_config</span><span class="o">.</span><span class="n">get_options</span><span class="p">()</span><span class="o">.</span><span class="n">environment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_logger</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_init_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger_linked_bronze_config</span><span class="p">:</span>
            <span class="c1"># Establish a connection to EXPLOIT schema to log message</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger_db_param</span> <span class="o">=</span> <span class="n">get_parser_config_settings</span><span class="p">(</span><span class="s2">&quot;database&quot;</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger_linked_bronze_config</span><span class="o">.</span><span class="n">get_configuration_file</span><span class="p">(),</span>
                                                                           <span class="bp">self</span><span class="o">.</span><span class="n">logger_linked_bronze_config</span><span class="o">.</span><span class="n">get_options</span><span class="p">()</span><span class="o">.</span><span class="n">logger_db</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger_db</span><span class="p">:</span><span class="n">absdb</span> <span class="o">=</span> <span class="n">DBFACTORY</span><span class="o">.</span><span class="n">create_instance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_db_parameters</span><span class="p">()</span><span class="o">.</span><span class="n">dbwrapper</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">logger_linked_bronze_config</span><span class="o">.</span><span class="n">get_configuration_file</span><span class="p">())</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger_oracledb_connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">()</span><span class="o">.</span><span class="n">create_db_connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_db_parameters</span><span class="p">())</span>

            <span class="c1"># Set Process_info = hostname:user:pid</span>
            <span class="n">vProcess_info</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">(),</span><span class="n">os</span><span class="o">.</span><span class="n">getlogin</span><span class="p">(),</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">BronzeLoggerProperties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">()</span><span class="o">.</span><span class="n">create_namedtuple_from_table</span><span class="p">(</span><span class="s1">&#39;BronzeLoggerProperties&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">logger_table_name</span><span class="p">)</span>
            <span class="c1">#self.instance_bronzeloggerproperties = self.BronzeLoggerProperties(START_TIME=datetime.now(tz=timezone.utc),END_TIME=None, ENVIRONMENT=self.env,ACTION=&#39;&#39;,SRC_NAME=&#39;&#39;,SRC_ORIGIN_NAME=&#39;&#39;,SRC_OBJECT_NAME=&#39;&#39;,REQUEST=&#39;&#39;,ERROR_TYPE=&#39;&#39;,ERROR_MESSAGE=&#39;&#39;,STAT_ROWS_COUNT=0,STAT_ROWS_SIZE=0,STAT_TOTAL_DURATION=0,STAT_FETCH_DURATION=0,STAT_UPLOAD_PARQUETS_DURATION=0,STAT_SENT_PARQUETS_COUNT=0,STAT_SENT_PARQUETS_SIZE=0)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instance_bronzeloggerproperties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BronzeLoggerProperties</span><span class="p">(</span><span class="n">START_TIME</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span><span class="n">ENVIRONMENT</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger_env</span><span class="p">,</span><span class="n">PROCESS_INFO</span><span class="o">=</span><span class="n">vProcess_info</span><span class="p">)</span>

<div class="viewcode-block" id="BronzeLogger.get_db">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeLogger.get_db">[docs]</a>
    <span class="k">def</span> <span class="nf">get_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger_db</span></div>

    
<div class="viewcode-block" id="BronzeLogger.get_db_parameters">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeLogger.get_db_parameters">[docs]</a>
    <span class="k">def</span> <span class="nf">get_db_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger_db_param</span></div>

    
<div class="viewcode-block" id="BronzeLogger.get_db_connection">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeLogger.get_db_connection">[docs]</a>
    <span class="k">def</span> <span class="nf">get_db_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger_oracledb_connection</span></div>

    
<div class="viewcode-block" id="BronzeLogger.link_to_bronze_source">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeLogger.link_to_bronze_source">[docs]</a>
    <span class="k">def</span> <span class="nf">link_to_bronze_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pBronze_source</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger_linked_bronze_source</span><span class="p">:</span><span class="n">BronzeSourceBuilder</span> <span class="o">=</span> <span class="n">pBronze_source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger_linked_bronze_config</span><span class="p">:</span><span class="n">BronzeConfig</span> <span class="o">=</span> <span class="n">pBronze_source</span><span class="o">.</span><span class="n">get_bronze_config</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger_env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger_linked_bronze_source</span><span class="o">.</span><span class="n">get_bronze_properties</span><span class="p">()</span><span class="o">.</span><span class="n">environment</span>
        <span class="n">vSourceProperties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger_linked_bronze_source</span><span class="o">.</span><span class="n">get_bronze_source_properties</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_logger</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instance_bronzeloggerproperties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance_bronzeloggerproperties</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">SRC_NAME</span><span class="o">=</span><span class="n">vSourceProperties</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">SRC_ORIGIN_NAME</span><span class="o">=</span><span class="n">vSourceProperties</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span><span class="n">SRC_OBJECT_NAME</span><span class="o">=</span><span class="n">vSourceProperties</span><span class="o">.</span><span class="n">table</span><span class="p">)</span></div>


<div class="viewcode-block" id="BronzeLogger.set_logger_properties">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeLogger.set_logger_properties">[docs]</a>
    <span class="k">def</span> <span class="nf">set_logger_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p_src_name</span><span class="p">,</span><span class="n">p_src_origin_name</span><span class="p">,</span><span class="n">p_src_object_name</span><span class="p">,</span><span class="n">p_request</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">p_duration</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instance_bronzeloggerproperties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance_bronzeloggerproperties</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">SRC_NAME</span><span class="o">=</span><span class="n">p_src_name</span><span class="p">,</span><span class="n">SRC_ORIGIN_NAME</span><span class="o">=</span><span class="n">p_src_origin_name</span><span class="p">,</span><span class="n">SRC_OBJECT_NAME</span><span class="o">=</span><span class="n">p_src_object_name</span><span class="p">,</span><span class="n">REQUEST</span><span class="o">=</span><span class="n">p_request</span><span class="p">,</span><span class="n">STAT_TOTAL_DURATION</span><span class="o">=</span><span class="n">p_duration</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="BronzeLogger.get_log_table">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeLogger.get_log_table">[docs]</a>
    <span class="k">def</span> <span class="nf">get_log_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger_table_name</span></div>


<div class="viewcode-block" id="BronzeLogger.log">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeLogger.log">[docs]</a>
    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pAction</span><span class="o">=</span><span class="s2">&quot;COMPLETED&quot;</span><span class="p">,</span><span class="n">pError</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">v_action</span> <span class="o">=</span> <span class="n">pAction</span>
        <span class="k">if</span> <span class="n">pError</span><span class="p">:</span>
            <span class="n">v_error_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">pError</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="n">v_error_message</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pError</span><span class="p">)</span>
            <span class="c1"># if error message contains warning then change action -&gt; WARNING</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;WARNING&quot;</span><span class="p">,</span><span class="n">v_error_message</span><span class="o">.</span><span class="n">upper</span><span class="p">()):</span>
                <span class="n">VAction</span> <span class="o">=</span> <span class="s2">&quot;WARNING&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">v_error_type</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">v_error_message</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger_linked_bronze_source</span><span class="p">:</span>
            <span class="n">v_source_durations_stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger_linked_bronze_source</span><span class="o">.</span><span class="n">get_durations_stats</span><span class="p">()</span>
            <span class="n">v_source_rows_stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger_linked_bronze_source</span><span class="o">.</span><span class="n">get_rows_stats</span><span class="p">()</span>
            <span class="n">v_source_parquets_stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger_linked_bronze_source</span><span class="o">.</span><span class="n">get_parquets_stats</span><span class="p">()</span>
            <span class="n">v_source_properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger_linked_bronze_source</span><span class="o">.</span><span class="n">get_bronze_source_properties</span><span class="p">()</span>
            <span class="n">v_source_lastupdated_row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger_linked_bronze_source</span><span class="o">.</span><span class="n">get_bronze_row_lastupdate_date</span><span class="p">()</span>
            <span class="n">v_source_bucket_parquet_files_sent</span> <span class="o">=</span> <span class="n">list_to_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger_linked_bronze_source</span><span class="o">.</span><span class="n">get_bucket_parquet_files_sent</span><span class="p">())</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">instance_bronzeloggerproperties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance_bronzeloggerproperties</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
                <span class="n">REQUEST</span><span class="o">=</span><span class="n">v_source_properties</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">ACTION</span><span class="o">=</span><span class="n">v_action</span><span class="p">,</span> <span class="n">END_TIME</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span><span class="n">ERROR_TYPE</span><span class="o">=</span><span class="n">v_error_type</span><span class="p">,</span><span class="n">ERROR_MESSAGE</span><span class="o">=</span><span class="n">v_error_message</span><span class="p">,</span>
                <span class="n">STAT_ROWS_COUNT</span><span class="o">=</span><span class="n">v_source_rows_stats</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">STAT_ROWS_SIZE</span><span class="o">=</span><span class="n">v_source_rows_stats</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">STAT_SENT_PARQUETS_COUNT</span><span class="o">=</span><span class="n">v_source_parquets_stats</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">STAT_SENT_PARQUETS_SIZE</span><span class="o">=</span><span class="n">v_source_parquets_stats</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">STAT_TOTAL_DURATION</span><span class="o">=</span><span class="n">v_source_durations_stats</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">STAT_FETCH_DURATION</span><span class="o">=</span><span class="n">v_source_durations_stats</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">STAT_UPLOAD_PARQUETS_DURATION</span><span class="o">=</span><span class="n">v_source_durations_stats</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">STAT_TEMP_PARQUETS_COUNT</span><span class="o">=</span><span class="n">v_source_parquets_stats</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">ATTRIBUTE1</span><span class="o">=</span><span class="n">v_source_lastupdated_row</span><span class="p">,</span>
                <span class="n">ATTRIBUTE6</span><span class="o">=</span><span class="n">v_source_bucket_parquet_files_sent</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instance_bronzeloggerproperties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance_bronzeloggerproperties</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
                <span class="n">ACTION</span><span class="o">=</span><span class="n">v_action</span><span class="p">,</span> <span class="n">END_TIME</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span><span class="n">ERROR_TYPE</span><span class="o">=</span><span class="n">v_error_type</span><span class="p">,</span><span class="n">ERROR_MESSAGE</span><span class="o">=</span><span class="n">v_error_message</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">__insertlog__</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">__insertlog__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">()</span><span class="o">.</span><span class="n">insert_namedtuple_into_table</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instance_bronzeloggerproperties</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">logger_table_name</span><span class="p">)</span></div>


<div class="viewcode-block" id="BronzeExploit">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeExploit">[docs]</a>
<span class="k">class</span> <span class="nc">BronzeExploit</span><span class="p">:</span>
    <span class="c1"># Iterator object for list of sources to be imported into Bronze</span>
    <span class="c1"># Define metohd to update src_dat_lastupdate for table with incremental integration</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p_bronze_config</span><span class="p">:</span><span class="n">BronzeConfig</span><span class="p">,</span><span class="n">p_logger</span><span class="p">:</span><span class="n">BronzeLogger</span><span class="p">,</span><span class="n">p_verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="o">**</span><span class="n">optional_args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">p_verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">p_logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exploit_config</span> <span class="o">=</span> <span class="n">p_bronze_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exploit_db_param</span> <span class="o">=</span> <span class="n">get_parser_config_settings</span><span class="p">(</span><span class="s2">&quot;database&quot;</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">exploit_config</span><span class="o">.</span><span class="n">get_configuration_file</span><span class="p">(),</span><span class="s2">&quot;exploit&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exploit_db</span><span class="p">:</span><span class="n">absdb</span> <span class="o">=</span> <span class="n">DBFACTORY</span><span class="o">.</span><span class="n">create_instance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exploit_db_param</span><span class="o">.</span><span class="n">dbwrapper</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">exploit_config</span><span class="o">.</span><span class="n">get_configuration_file</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exploit_db_connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exploit_db</span><span class="o">.</span><span class="n">create_db_connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exploit_db_param</span><span class="p">)</span>

        <span class="n">v_cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db_connection</span><span class="p">()</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="c1"># drop temporary running loding table or Not (Default) </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">not_drop_running_loading_table</span> <span class="o">=</span> <span class="n">optional_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">EXPLOIT_ARG_NOT_DROP_TEMP_RUNNING_LOADING_TABLE</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Create running/temporary List Datasource loading table.</span>
        <span class="c1"># Insert list of tables to import</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">exploit_loading_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exploit_config</span><span class="o">.</span><span class="n">get_options</span><span class="p">()</span><span class="o">.</span><span class="n">datasource_load_tablename_prefix</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">exploit_config</span><span class="o">.</span><span class="n">get_options</span><span class="p">()</span><span class="o">.</span><span class="n">environment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exploit_running_loading_table</span> <span class="o">=</span> <span class="n">format_temporary_tablename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exploit_loading_table</span><span class="p">)</span>
        <span class="n">v_message</span> <span class="o">=</span> <span class="s2">&quot;Create running exploit loading table  </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exploit_running_loading_table</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;EXPLOIT&quot;</span><span class="p">,</span> <span class="s2">&quot;START&quot;</span><span class="p">,</span> <span class="n">log_message</span><span class="o">=</span><span class="n">v_message</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">optional_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">EXPLOIT_ARG_LOADING_TABLE</span><span class="p">,</span><span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">batch_loading_table</span> <span class="o">=</span> <span class="n">optional_args</span><span class="p">[</span><span class="n">EXPLOIT_ARG_LOADING_TABLE</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>    
            <span class="bp">self</span><span class="o">.</span><span class="n">batch_loading_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exploit_loading_table</span>
        
        <span class="n">v_log_table</span> <span class="o">=</span> <span class="n">optional_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">EXPLOIT_ARG_LOG_TABLE</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">v_interval_start</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">v_interval_end</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">optional_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">EXPLOIT_ARG_RELOAD_ON_ERROR_INTERVAL</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span> <span class="p">:</span>
            <span class="n">v_interval_start</span> <span class="o">=</span> <span class="n">optional_args</span><span class="p">[</span><span class="n">EXPLOIT_ARG_RELOAD_ON_ERROR_INTERVAL</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
            <span class="c1"># If end date of intervant not provided, then take Now date</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">v_interval_end</span> <span class="o">=</span> <span class="n">optional_args</span><span class="p">[</span><span class="n">EXPLOIT_ARG_RELOAD_ON_ERROR_INTERVAL</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="n">v_interval_end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>

            <span class="n">v_message</span> <span class="o">=</span> <span class="s2">&quot;Populate exploit loading table </span><span class="si">{}</span><span class="s2"> with previous error tables from log table </span><span class="si">{}</span><span class="s2"> on interval </span><span class="si">{}</span><span class="s2">-&gt;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exploit_running_loading_table</span><span class="p">,</span><span class="n">v_log_table</span><span class="p">,</span><span class="n">v_interval_start</span><span class="p">,</span><span class="n">v_interval_end</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;EXPLOIT&quot;</span><span class="p">,</span> <span class="s2">&quot;START&quot;</span><span class="p">,</span> <span class="n">log_message</span><span class="o">=</span><span class="n">v_message</span><span class="p">)</span>
        <span class="n">v_dmbs_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">()</span><span class="o">.</span><span class="n">execute_proc</span><span class="p">(</span><span class="s1">&#39;LH2_EXPLOIT_ADMIN_PKG.CREATE_LH2_DATASOURCE_LOADING_PROC&#39;</span><span class="p">,</span><span class="o">*</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">exploit_loading_table</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_loading_table</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">exploit_running_loading_table</span><span class="p">,</span><span class="n">v_log_table</span><span class="p">,</span><span class="n">v_interval_start</span><span class="p">,</span><span class="n">v_interval_end</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_db_connection</span><span class="p">()</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">()</span><span class="o">.</span><span class="n">last_execute_proc_completion</span><span class="p">():</span>
            <span class="n">v_message</span> <span class="o">=</span> <span class="s2">&quot;ERROR, Create running exploit loading table  </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exploit_running_loading_table</span><span class="p">)</span>
            <span class="n">v_message</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">()</span><span class="o">.</span><span class="n">last_execute_proc_output</span><span class="p">())</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;EXPLOIT&quot;</span><span class="p">,</span> <span class="s2">&quot;ERROR&quot;</span><span class="p">,</span> <span class="n">log_message</span><span class="o">=</span><span class="n">v_message</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">v_message</span><span class="p">)</span>
        
        <span class="c1">#define SourceProperties namedtuple as a global type</span>
        <span class="k">global</span> <span class="n">SourceProperties</span>
        <span class="n">v_loadingTableProperties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">()</span><span class="o">.</span><span class="n">create_namedtuple_from_table</span><span class="p">(</span><span class="s1">&#39;SourceProperties&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">exploit_running_loading_table</span><span class="p">)</span>
        <span class="n">v_new_fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">SOURCE_PROPERTIES_SYNONYMS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">old_name</span><span class="p">,</span><span class="n">old_name</span><span class="p">)</span> <span class="k">for</span> <span class="n">old_name</span> <span class="ow">in</span> <span class="n">v_loadingTableProperties</span><span class="o">.</span><span class="n">_fields</span><span class="p">]</span>
        <span class="n">v_new_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;request&#39;</span><span class="p">)</span>
        <span class="n">v_defaults_values</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">v_new_fields</span><span class="p">)</span>
        <span class="n">SourceProperties</span> <span class="o">=</span> <span class="n">namedtuple</span> <span class="p">(</span><span class="s1">&#39;SourceProperties&#39;</span><span class="p">,</span><span class="n">v_new_fields</span><span class="p">,</span><span class="n">defaults</span><span class="o">=</span><span class="n">v_defaults_values</span><span class="p">)</span>
        
        <span class="c1"># Execute a SQL query to fetch activ data from the table &quot;LIST_DATASOURCE_LOADING_...&quot; into a dataframe</span>
        <span class="n">v_sql</span> <span class="o">=</span> <span class="s2">&quot;select * from &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">exploit_running_loading_table</span> <span class="o">+</span> <span class="s2">&quot; where SRC_FLAG_ACTIV = 1 ORDER BY SRC_TYPE,SRC_NAME,SRC_OBJECT_NAME&quot;</span>
        <span class="n">v_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">v_sql</span><span class="p">)</span>
        <span class="n">v_df_exploit_datasource</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">v_cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
        <span class="n">v_df_exploit_datasource</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v_cursor</span><span class="o">.</span><span class="n">description</span><span class="p">]</span>
        <span class="c1"># Test if query set to filter data sources</span>
        <span class="n">v_query</span> <span class="o">=</span> <span class="n">optional_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">EXPLOIT_ARG_QUERY</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">optional_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">EXPLOIT_ARG_QUERY</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_exploit_datasource_loading</span> <span class="o">=</span> <span class="n">create_filter_mask</span><span class="p">(</span><span class="n">v_df_exploit_datasource</span><span class="p">,</span><span class="n">v_query</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_exploit_datasource_loading</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ERROR, Filtering loading tables list, review your query&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_exploit_datasource_loading</span> <span class="o">=</span> <span class="n">v_df_exploit_datasource</span>
        <span class="n">v_datasource_loading_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_exploit_datasource_loading</span><span class="p">[</span><span class="s1">&#39;SRC_OBJECT_NAME&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">p_verbose</span><span class="p">:</span>
            <span class="n">v_log_message</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> data sources to load : </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v_datasource_loading_list</span><span class="p">),</span><span class="n">v_datasource_loading_list</span><span class="p">)</span>
            <span class="n">p_verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;DATASOURCE_LOADING&quot;</span><span class="p">,</span> <span class="s2">&quot;STARTING&quot;</span><span class="p">,</span> <span class="n">log_message</span><span class="o">=</span><span class="n">v_log_message</span><span class="p">)</span>
        <span class="n">v_cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">not_drop_running_loading_table</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Deleting temporary Exploit table  </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exploit_running_loading_table</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;EXPLOIT&quot;</span><span class="p">,</span> <span class="s2">&quot;END&quot;</span><span class="p">,</span> <span class="n">log_message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">()</span><span class="o">.</span><span class="n">execute_proc</span><span class="p">(</span><span class="s1">&#39;LH2_EXPLOIT_ADMIN_PKG.DROP_TABLE_PROC&#39;</span><span class="p">,</span> <span class="o">*</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">exploit_running_loading_table</span><span class="p">])</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">()</span><span class="o">.</span><span class="n">last_execute_proc_output</span><span class="p">())</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;EXPLOIT&quot;</span><span class="p">,</span> <span class="s2">&quot;END&quot;</span><span class="p">,</span> <span class="n">log_message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>
   
    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Reset the index whenever a new iterator is requested</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1">#items = [self.df_param.iloc[self.idx,i] for i in range(len(self.df_param.columns))]</span>
            <span class="n">v_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_exploit_datasource_loading</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">v_items</span> <span class="o">=</span> <span class="n">SourceProperties</span><span class="p">(</span><span class="o">*</span><span class="n">v_line</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">v_items</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_key</span><span class="p">):</span>
        <span class="n">v_df_filtered_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_exploit_datasource_loading</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df_exploit_datasource_loading</span><span class="p">[</span><span class="s1">&#39;BRONZE_TABLE_NAME&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">p_key</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">v_df_filtered_data</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Key &#39;</span><span class="si">{</span><span class="n">p_key</span><span class="si">}</span><span class="s2">&#39; not found&quot;</span><span class="p">)</span>
        <span class="n">v_line</span> <span class="o">=</span> <span class="n">v_df_filtered_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">v_items</span> <span class="o">=</span> <span class="n">SourceProperties</span><span class="p">(</span><span class="o">*</span><span class="n">v_line</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v_items</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_key</span><span class="p">,</span> <span class="n">p_value</span><span class="p">):</span>
        <span class="n">v_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df_exploit_datasource_loading</span><span class="p">[</span><span class="s1">&#39;BRONZE_TABLE_NAME&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">p_key</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">v_index</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_exploit_datasource_loading</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">v_index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_exploit_datasource_loading</span><span class="o">.</span><span class="n">columns</span> <span class="o">!=</span> <span class="s1">&#39;BRONZE_TABLE_NAME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">v_new_row</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">p_value</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df_exploit_datasource_loading</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;BRONZE_TABLE_NAME&#39;</span><span class="p">))</span>
            <span class="n">v_new_row</span><span class="p">[</span><span class="s1">&#39;BRONZE_TABLE_NAME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_key</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_exploit_datasource_loading</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v_new_row</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="BronzeExploit.items">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeExploit.items">[docs]</a>
    <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_exploit_datasource_loading</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">v_line</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">v_items</span> <span class="o">=</span> <span class="n">SourceProperties</span><span class="p">(</span><span class="o">*</span><span class="n">v_line</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;BRONZE_TABLE_NAME&#39;</span><span class="p">],</span> <span class="n">v_items</span></div>


<div class="viewcode-block" id="BronzeExploit.keys">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeExploit.keys">[docs]</a>
    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_exploit_datasource_loading</span><span class="p">[</span><span class="s1">&#39;BRONZE_TABLE_NAME&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="BronzeExploit.values">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeExploit.values">[docs]</a>
    <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_exploit_datasource_loading</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">v_line</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">v_items</span> <span class="o">=</span> <span class="n">SourceProperties</span><span class="p">(</span><span class="o">*</span><span class="n">v_line</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">v_items</span></div>

            
<div class="viewcode-block" id="BronzeExploit.get_db">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeExploit.get_db">[docs]</a>
    <span class="k">def</span> <span class="nf">get_db</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">absdb</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exploit_db</span></div>

    
<div class="viewcode-block" id="BronzeExploit.get_db_parameters">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeExploit.get_db_parameters">[docs]</a>
    <span class="k">def</span> <span class="nf">get_db_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exploit_db_param</span></div>

    
<div class="viewcode-block" id="BronzeExploit.get_db_connection">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeExploit.get_db_connection">[docs]</a>
    <span class="k">def</span> <span class="nf">get_db_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exploit_db_connection</span></div>

    
<div class="viewcode-block" id="BronzeExploit.get_loading_tables">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeExploit.get_loading_tables">[docs]</a>
    <span class="k">def</span> <span class="nf">get_loading_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exploit_loading_table</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">exploit_running_loading_table</span><span class="p">)</span></div>


<div class="viewcode-block" id="BronzeExploit.update_exploit">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeExploit.update_exploit">[docs]</a>
    <span class="k">def</span> <span class="nf">update_exploit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p_dict_column_name_value</span><span class="p">,</span><span class="n">p_source</span><span class="p">:</span><span class="n">SourceProperties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">p_bronze_table_name</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># update exploit table with column and values provided into p_dict_column_name_value {&#39;column1&#39;:value1,&#39;column2&#39;:value2....}</span>
        <span class="c1"># update is done on Source : Database name, schema, table</span>
        <span class="n">v_request</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">v_cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db_connection</span><span class="p">()</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="c1"># build SQL UPDATE SQL request</span>
            <span class="n">v_request</span> <span class="o">=</span> <span class="s2">&quot;UPDATE &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">exploit_loading_table</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
            <span class="c1">#v_request = &quot;UPDATE &quot; + self.exploit_loading_table + &quot; SET &quot;+p_column_name+&quot; = :1 WHERE SRC_NAME = :2 AND SRC_ORIGIN_NAME = :3 AND SRC_OBJECT_NAME = :4&quot;</span>
            <span class="n">v_offset</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">v_set</span> <span class="o">=</span> <span class="s2">&quot;SET &quot;</span><span class="o">+</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">INVERTED_SOURCE_PROPERTIES_SYNONYMS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">column</span><span class="p">,</span><span class="n">column</span><span class="p">)</span><span class="si">}</span><span class="s2"> =:</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="n">v_offset</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">column</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p_dict_column_name_value</span><span class="o">.</span><span class="n">keys</span><span class="p">())])</span>
            <span class="n">v_offset</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">p_dict_column_name_value</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
            <span class="c1"># if source is specified (database name, schema, table) then update row based on this columns</span>
            <span class="k">if</span> <span class="n">p_source</span><span class="p">:</span>
                <span class="n">v_dict_join</span> <span class="o">=</span> <span class="p">{</span><span class="n">INVERTED_SOURCE_PROPERTIES_SYNONYMS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">):</span><span class="n">p_source</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">INVERTED_SOURCE_PROPERTIES_SYNONYMS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;schema&#39;</span><span class="p">):</span><span class="n">p_source</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span><span class="n">INVERTED_SOURCE_PROPERTIES_SYNONYMS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;table&#39;</span><span class="p">):</span><span class="n">p_source</span><span class="o">.</span><span class="n">table</span><span class="p">}</span>    
            <span class="c1"># if bronze table is specified, then update row for this bronze table</span>
            <span class="c1"># for example, needed when drop a bronze table to update exploit</span>
            <span class="k">if</span> <span class="n">p_bronze_table_name</span><span class="p">:</span>
                <span class="n">v_dict_join</span> <span class="o">=</span> <span class="p">{</span><span class="n">INVERTED_SOURCE_PROPERTIES_SYNONYMS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bronze_table_name&#39;</span><span class="p">):</span><span class="n">p_bronze_table_name</span><span class="p">}</span>
            
            <span class="n">v_join</span><span class="o">=</span> <span class="s2">&quot;AND &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2"> =:</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="n">v_offset</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">column</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">v_dict_join</span><span class="o">.</span><span class="n">keys</span><span class="p">())])</span>
            <span class="n">v_bindvars</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">p_dict_column_name_value</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">+</span><span class="nb">list</span><span class="p">(</span><span class="n">v_dict_join</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
            <span class="n">v_request</span> <span class="o">=</span> <span class="n">v_request</span> <span class="o">+</span> <span class="n">v_set</span> <span class="o">+</span> <span class="s2">&quot; WHERE &quot;</span><span class="o">+</span> <span class="n">v_join</span>
            
            <span class="c1"># update last date or creation date (depends on table)</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Updating request : </span><span class="si">{}</span><span class="s2"> Bind Values :  </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_request</span><span class="p">,</span><span class="n">v_bindvars</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;SET_LASTUPDATE&quot;</span><span class="p">,</span> <span class="s2">&quot;START&quot;</span><span class="p">,</span> <span class="n">log_message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
                            <span class="n">log_request</span><span class="o">=</span><span class="n">v_request</span><span class="p">)</span>
            <span class="n">v_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">v_request</span><span class="p">,</span><span class="n">v_bindvars</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_db_connection</span><span class="p">()</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="n">v_cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="n">oracledb</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">v_err</span><span class="p">:</span>
            <span class="n">v_error</span> <span class="o">=</span> <span class="s2">&quot;ERROR </span><span class="si">{}</span><span class="s2"> with values </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_request</span><span class="p">,</span><span class="n">v_bindvars</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;UPDATE_EXPLOIT&quot;</span><span class="p">,</span> <span class="n">v_error</span><span class="p">,</span><span class="n">log_message</span><span class="o">=</span><span class="s1">&#39;Oracle DB error : </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">v_err</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pError</span><span class="o">=</span><span class="n">v_err</span><span class="p">,</span> <span class="n">pAction</span><span class="o">=</span><span class="n">v_error</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">v_err</span><span class="p">:</span>
            <span class="n">v_error</span> <span class="o">=</span> <span class="s2">&quot;ERROR </span><span class="si">{}</span><span class="s2"> with values </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_request</span><span class="p">,</span> <span class="n">v_bindvars</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;UPDATE_EXPLOIT&quot;</span><span class="p">,</span> <span class="n">v_error</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">v_err</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pError</span><span class="o">=</span><span class="n">v_err</span><span class="p">,</span> <span class="n">pAction</span><span class="o">=</span><span class="n">v_error</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>


    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;BronzeExploit: exploit_running_loading_table=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">exploit_running_loading_table</span><span class="si">}</span><span class="s2">, df_param=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">df_exploit_datasource_loading</span><span class="si">}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="BronzeDbManager">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeDbManager">[docs]</a>
<span class="k">class</span> <span class="nc">BronzeDbManager</span><span class="p">:</span>
    <span class="c1"># object to manage connection to bronze database</span>
    <span class="c1"># provide main functions to manage Bronze DB activities</span>
    <span class="n">gather_lh2_bronze_tables_stats_status</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pBronze_config</span><span class="p">:</span><span class="n">BronzeConfig</span><span class="p">,</span><span class="n">pLogger</span><span class="p">:</span><span class="n">BronzeLogger</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bronzeDb_Manager_config</span> <span class="o">=</span> <span class="n">pBronze_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bronzeDbManager_env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronzeDb_Manager_config</span><span class="o">.</span><span class="n">get_options</span><span class="p">()</span><span class="o">.</span><span class="n">environment</span>
        <span class="c1"># Bronze Database name - defined into config.json file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bronzeDb_Manager_database_name</span> <span class="o">=</span> <span class="s2">&quot;BRONZE_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronzeDbManager_env</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bronzeDb_Manager_logger</span> <span class="o">=</span> <span class="n">pLogger</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">pre_proc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronzeDb_Manager_config</span><span class="o">.</span><span class="n">get_options</span><span class="p">()</span><span class="o">.</span><span class="n">PLSQL_pre_proc</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronzeDb_Manager_config</span><span class="o">.</span><span class="n">get_options</span><span class="p">()</span><span class="o">.</span><span class="n">PLSQL_pre_proc_args</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pre_proc_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronzeDb_Manager_config</span><span class="o">.</span><span class="n">get_options</span><span class="p">()</span><span class="o">.</span><span class="n">PLSQL_pre_proc_args</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pre_proc_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">post_proc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronzeDb_Manager_config</span><span class="o">.</span><span class="n">get_options</span><span class="p">()</span><span class="o">.</span><span class="n">PLSQL_post_proc</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronzeDb_Manager_config</span><span class="o">.</span><span class="n">get_options</span><span class="p">()</span><span class="o">.</span><span class="n">PLSQL_post_proc_args</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">post_proc_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronzeDb_Manager_config</span><span class="o">.</span><span class="n">get_options</span><span class="p">()</span><span class="o">.</span><span class="n">PLSQL_post_proc_args</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">post_proc_args</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">garbage_options</span> <span class="o">=</span> <span class="kc">None</span>
        
         <span class="c1"># Establish connection to Bronze schema database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bronzeDb_Manager_Database_param</span> <span class="o">=</span> <span class="n">get_parser_config_settings</span><span class="p">(</span><span class="s2">&quot;database&quot;</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">bronzeDb_Manager_config</span><span class="o">.</span><span class="n">get_configuration_file</span><span class="p">(),</span>
                                                                            <span class="bp">self</span><span class="o">.</span><span class="n">get_bronze_database_name</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bronzeDb_Manager_db</span><span class="p">:</span><span class="n">absdb</span> <span class="o">=</span> <span class="n">DBFACTORY</span><span class="o">.</span><span class="n">create_instance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bronzeDb_Manager_Database_param</span><span class="o">.</span><span class="n">dbwrapper</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bronzeDb_Manager_config</span><span class="o">.</span><span class="n">get_configuration_file</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bronzeDb_Manager_db_connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">()</span><span class="o">.</span><span class="n">create_db_connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bronzeDb_Manager_Database_param</span><span class="p">)</span>
    
        <span class="bp">self</span><span class="o">.</span><span class="n">df_bronze_tables_stats</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">__init_garbage_options__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">garbage_options</span> <span class="o">=</span> <span class="n">get_parser_config_settings</span><span class="p">(</span><span class="s2">&quot;garbage_options&quot;</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">bronzeDb_Manager_config</span><span class="o">.</span><span class="n">get_configuration_file</span><span class="p">(),</span><span class="s2">&quot;garbage_options&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gather_lh2_tables_stats_proc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">garbage_options</span><span class="o">.</span><span class="n">PLSQL_gather_lh2_tables_stats_proc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gather_lh2_tables_stats_proc_args</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_db_username</span><span class="p">()]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">garbage_options</span><span class="o">.</span><span class="n">PLSQL_gather_lh2_tables_stats_proc_args</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gather_lh2_tables_stats_proc_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gather_lh2_tables_stats_proc_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">garbage_options</span><span class="o">.</span><span class="n">PLSQL_gather_lh2_tables_stats_proc_args</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lh2_tables_tablename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">garbage_options</span><span class="o">.</span><span class="n">LH2_TABLES_TABLENAME</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filestorage_for_excel_export</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">garbage_options</span><span class="o">.</span><span class="n">filestorage_for_excel_export</span>
    
<div class="viewcode-block" id="BronzeDbManager.get_db">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeDbManager.get_db">[docs]</a>
    <span class="k">def</span> <span class="nf">get_db</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">absdb</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronzeDb_Manager_db</span></div>

    
<div class="viewcode-block" id="BronzeDbManager.get_db_parameters">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeDbManager.get_db_parameters">[docs]</a>
    <span class="k">def</span> <span class="nf">get_db_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronzeDb_Manager_Database_param</span></div>

    
<div class="viewcode-block" id="BronzeDbManager.get_db_connection">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeDbManager.get_db_connection">[docs]</a>
    <span class="k">def</span> <span class="nf">get_db_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronzeDb_Manager_db_connection</span></div>

    
<div class="viewcode-block" id="BronzeDbManager.get_bronze_database_name">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeDbManager.get_bronze_database_name">[docs]</a>
    <span class="k">def</span> <span class="nf">get_bronze_database_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronzeDb_Manager_database_name</span></div>

    
<div class="viewcode-block" id="BronzeDbManager.get_db_username">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeDbManager.get_db_username">[docs]</a>
    <span class="k">def</span> <span class="nf">get_db_username</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db_parameters</span><span class="p">()</span><span class="o">.</span><span class="n">p_username</span></div>

    
<div class="viewcode-block" id="BronzeDbManager.get_pre_proc">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeDbManager.get_pre_proc">[docs]</a>
    <span class="k">def</span> <span class="nf">get_pre_proc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre_proc</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pre_proc_args</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="BronzeDbManager.get_post_proc">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeDbManager.get_post_proc">[docs]</a>
    <span class="k">def</span> <span class="nf">get_post_proc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">post_proc</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">post_proc_args</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="BronzeDbManager.is_table_exists">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeDbManager.is_table_exists">[docs]</a>
    <span class="k">def</span> <span class="nf">is_table_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p_table_name</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db_connection</span><span class="p">():</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">()</span><span class="o">.</span><span class="n">is_table_exists</span><span class="p">(</span><span class="n">p_table_name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">get_db_username</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">res</span></div>

    
<div class="viewcode-block" id="BronzeDbManager.get_bronze_lastupdated_row">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeDbManager.get_bronze_lastupdated_row">[docs]</a>
    <span class="k">def</span> <span class="nf">get_bronze_lastupdated_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p_table_name</span><span class="p">,</span><span class="n">p_src_date_criteria</span><span class="p">,</span><span class="n">p_where</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">last_date</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db_connection</span><span class="p">():</span>
            <span class="n">last_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">()</span><span class="o">.</span><span class="n">get_table_max_column</span><span class="p">(</span><span class="n">p_table_name</span><span class="p">,</span> <span class="n">p_src_date_criteria</span><span class="p">,</span><span class="n">p_where</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">last_date</span></div>

    
<div class="viewcode-block" id="BronzeDbManager.run_proc">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeDbManager.run_proc">[docs]</a>
    <span class="k">def</span> <span class="nf">run_proc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p_proc_name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="o">/</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="n">p_verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">p_proc_exe_context</span><span class="o">=</span><span class="s1">&#39;GLOBAL&#39;</span><span class="p">):</span>
        <span class="n">v_start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">v_return</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">v_request</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">(</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_proc_name</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p_proc_name</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">():</span>
                <span class="n">v_dmbs_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">()</span><span class="o">.</span><span class="n">execute_proc</span><span class="p">(</span><span class="n">p_proc_name</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
                <span class="n">v_log_message</span> <span class="o">=</span> <span class="n">v_dmbs_output</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">()</span><span class="o">.</span><span class="n">last_execute_proc_completion</span><span class="p">():</span>
                    <span class="n">v_action</span> <span class="o">=</span> <span class="s2">&quot;COMPLETED&quot;</span>
                    <span class="n">v_err</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">v_return</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">v_action</span> <span class="o">=</span> <span class="s2">&quot;ERROR&quot;</span>
                    <span class="n">v_err</span> <span class="o">=</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Error during execution of procedure </span><span class="si">{}</span><span class="s2"> with </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_proc_name</span><span class="p">,</span><span class="n">args</span><span class="p">))</span>
                    <span class="n">v_return</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">v_err</span> <span class="o">=</span> <span class="n">err</span>
            <span class="n">v_action</span> <span class="o">=</span> <span class="s2">&quot;ERROR calling Procedure </span><span class="si">{}</span><span class="s2"> with </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_proc_name</span><span class="p">,</span><span class="n">args</span><span class="p">)</span>
            <span class="n">v_log_message</span> <span class="o">=</span> <span class="s1">&#39;Oracle DB error :</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">v_err</span><span class="p">))</span>
            <span class="n">v_return</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">v_duration</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">v_start</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bronzeDb_Manager_logger</span><span class="o">.</span><span class="n">set_logger_properties</span><span class="p">(</span><span class="n">p_src_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_bronze_database_name</span><span class="p">(),</span><span class="n">p_src_origin_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_db_username</span><span class="p">(),</span><span class="n">p_src_object_name</span><span class="o">=</span><span class="n">p_proc_exe_context</span><span class="p">,</span><span class="n">p_request</span><span class="o">=</span><span class="n">v_request</span><span class="p">,</span><span class="n">p_duration</span><span class="o">=</span><span class="n">v_duration</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">p_proc_name</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">p_verbose</span><span class="p">:</span>
                    <span class="n">p_verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;BRONZE_PROC&quot;</span><span class="p">,</span> <span class="n">v_action</span><span class="p">,</span> <span class="n">log_message</span><span class="o">=</span><span class="n">v_log_message</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bronzeDb_Manager_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pError</span><span class="o">=</span><span class="n">v_err</span><span class="p">,</span> <span class="n">pAction</span><span class="o">=</span><span class="n">v_action</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">v_return</span></div>

                 
<div class="viewcode-block" id="BronzeDbManager.run_pre_proc">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeDbManager.run_pre_proc">[docs]</a>
    <span class="k">def</span> <span class="nf">run_pre_proc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p_verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_proc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre_proc</span><span class="p">,</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pre_proc_args</span><span class="p">,</span><span class="n">p_verbose</span><span class="o">=</span><span class="n">p_verbose</span><span class="p">,</span><span class="n">p_proc_exe_context</span><span class="o">=</span><span class="s1">&#39;GLOBAL&#39;</span><span class="p">)</span></div>

        
<div class="viewcode-block" id="BronzeDbManager.run_post_proc">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeDbManager.run_post_proc">[docs]</a>
    <span class="k">def</span> <span class="nf">run_post_proc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p_verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
       <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_proc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">post_proc</span><span class="p">,</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">post_proc_args</span><span class="p">,</span><span class="n">p_verbose</span><span class="o">=</span><span class="n">p_verbose</span><span class="p">,</span><span class="n">p_proc_exe_context</span><span class="o">=</span><span class="s1">&#39;GLOBAL&#39;</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="BronzeDbManager.get_garbage_options">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeDbManager.get_garbage_options">[docs]</a>
    <span class="k">def</span> <span class="nf">get_garbage_options</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">garbage_options</span></div>

    
<div class="viewcode-block" id="BronzeDbManager.get_gather_lh2_tables_stats_status">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeDbManager.get_gather_lh2_tables_stats_status">[docs]</a>
    <span class="k">def</span> <span class="nf">get_gather_lh2_tables_stats_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">gather_lh2_bronze_tables_stats_status</span></div>

    
<div class="viewcode-block" id="BronzeDbManager.get_lh2_bronze_tables_stats">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeDbManager.get_lh2_bronze_tables_stats">[docs]</a>
    <span class="k">def</span> <span class="nf">get_lh2_bronze_tables_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_bronze_tables_stats</span></div>

    
<div class="viewcode-block" id="BronzeDbManager.get_lh2_bronze_buckets">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeDbManager.get_lh2_bronze_buckets">[docs]</a>
    <span class="k">def</span> <span class="nf">get_lh2_bronze_buckets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_bronze_buckets_parquets</span></div>

    
<div class="viewcode-block" id="BronzeDbManager.gather_lh2_bronze_tables_stats">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeDbManager.gather_lh2_bronze_tables_stats">[docs]</a>
    <span class="k">def</span> <span class="nf">gather_lh2_bronze_tables_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p_refresh_stats</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">p_count_rows</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">p_verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Run PL/SQL procedure to collect LH2 bronze tables stats for current environment, from Oracle database</span>
        <span class="c1"># if p_refresh_stats is True, refresh parquets files lists for every external tables </span>
        <span class="c1"># (and identify zombies parquets files not associated to any external table)</span>
        <span class="c1"># if p_count_row, run a select count(1) from table to get number of row. </span>
        <span class="c1"># this option could be long</span>
        
        <span class="k">def</span> <span class="nf">__match_files_to_tables__</span><span class="p">(</span><span class="n">p_df</span><span class="p">,</span> <span class="n">p_list_file_objects</span><span class="p">):</span>
            <span class="c1"># Function to match files to external tables and handle &quot;zombies&quot;</span>
            <span class="c1"># p_df is a dataframe mapping LH2_TABLES with same columns - Contains list of external tables </span>
            <span class="c1"># p_list_file_objects : list of bucket objects .parquet. Parquets files are linked or not to external tables</span>
            <span class="n">v_matches</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">v_zombies</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="c1"># Dictionary to track file associations</span>
            <span class="n">v_file_associated</span> <span class="o">=</span> <span class="p">{</span><span class="n">v_file</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]:</span> <span class="p">{</span><span class="s1">&#39;associated&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span><span class="s1">&#39;size_mb&#39;</span><span class="p">:</span><span class="n">v_file</span><span class="p">[</span><span class="s1">&#39;size_mb&#39;</span><span class="p">]}</span> <span class="k">for</span> <span class="n">v_file</span> <span class="ow">in</span> <span class="n">p_list_file_objects</span><span class="p">}</span>

            <span class="c1"># Associate files with tables</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v_row</span> <span class="ow">in</span> <span class="n">p_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="n">v_table_data</span> <span class="o">=</span> <span class="n">v_row</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
                <span class="n">v_env</span> <span class="o">=</span> <span class="n">v_table_data</span><span class="p">[</span><span class="s1">&#39;ENV&#39;</span><span class="p">]</span>
                <span class="n">v_bucket</span> <span class="o">=</span> <span class="n">v_table_data</span><span class="p">[</span><span class="s1">&#39;BUCKET&#39;</span><span class="p">]</span>
                <span class="n">v_uri_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;o/(.*)&#39;</span><span class="p">,</span><span class="n">v_table_data</span><span class="p">[</span><span class="s1">&#39;FILE_URI&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>   
                <span class="n">v_matching_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">v_file</span> <span class="k">for</span> <span class="n">v_file</span> <span class="ow">in</span> <span class="n">p_list_file_objects</span> <span class="k">if</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">v_file</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">v_uri_pattern</span><span class="p">)]</span>
                
                <span class="k">for</span> <span class="n">v_file</span> <span class="ow">in</span> <span class="n">v_matching_files</span><span class="p">:</span>
                    <span class="n">v_file_associated</span><span class="p">[</span><span class="n">v_file</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]][</span><span class="s1">&#39;associated&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    
                <span class="c1"># update list fo parquets, number of parquet files and total size of parquet files</span>
                <span class="n">v_table_data</span><span class="p">[</span><span class="s1">&#39;LIST_PARQUETS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">v_file</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">v_file</span> <span class="ow">in</span> <span class="n">v_matching_files</span><span class="p">]</span>
                <span class="n">v_table_data</span><span class="p">[</span><span class="s1">&#39;NUM_PARQUETS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v_table_data</span><span class="p">[</span><span class="s1">&#39;LIST_PARQUETS&#39;</span><span class="p">])</span>
                <span class="n">v_table_data</span><span class="p">[</span><span class="s1">&#39;SIZE_MB&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">v_file</span><span class="p">[</span><span class="s1">&#39;size_mb&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">v_file</span> <span class="ow">in</span> <span class="n">v_matching_files</span><span class="p">])</span>
                <span class="n">v_matches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v_table_data</span><span class="p">)</span>
            
            <span class="c1"># Add &quot;zombie&quot; files</span>
            <span class="n">v_zombies_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">v_file_name</span> <span class="k">for</span> <span class="n">v_file_name</span><span class="p">,</span> <span class="n">v_row</span> <span class="ow">in</span> <span class="n">v_file_associated</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">v_row</span><span class="p">[</span><span class="s1">&#39;associated&#39;</span><span class="p">]]</span>
            <span class="n">v_zombies_files_size_temp</span> <span class="o">=</span> <span class="p">[</span><span class="n">v_row</span><span class="p">[</span><span class="s1">&#39;size_mb&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">v_file_name</span><span class="p">,</span> <span class="n">v_row</span> <span class="ow">in</span> <span class="n">v_file_associated</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">v_row</span><span class="p">[</span><span class="s1">&#39;associated&#39;</span><span class="p">]]</span>
            <span class="n">v_zombies_files_size</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">v_zombies_files_size_temp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v_zombies_files</span><span class="p">:</span>
                <span class="n">v_zombies_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="s1">&#39;&#39;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">p_df</span><span class="o">.</span><span class="n">columns</span><span class="p">}</span>
                <span class="c1"># add default values - For ENV and BUCKET set same values of last table inspected</span>
                <span class="n">v_zombies_data</span><span class="p">[</span><span class="s1">&#39;ENV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_env</span>
                <span class="n">v_zombies_data</span><span class="p">[</span><span class="s1">&#39;OWNER&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="n">v_zombies_data</span><span class="p">[</span><span class="s1">&#39;TABLE_NAME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ZOMBIES_TABLE_NAME</span>
                <span class="n">v_zombies_data</span><span class="p">[</span><span class="s1">&#39;PARTITIONED&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;NO&#39;</span>
                <span class="n">v_zombies_data</span><span class="p">[</span><span class="s1">&#39;TABLE_TYPE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">v_zombies_data</span><span class="p">[</span><span class="s1">&#39;NUM_ROWS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">v_zombies_data</span><span class="p">[</span><span class="s1">&#39;SIZE_MB&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_zombies_files_size</span>
                <span class="n">v_zombies_data</span><span class="p">[</span><span class="s1">&#39;BUCKET&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_bucket</span>
                <span class="n">v_zombies_data</span><span class="p">[</span><span class="s1">&#39;FILE_URI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="n">v_zombies_data</span><span class="p">[</span><span class="s1">&#39;NUM_PARQUETS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v_zombies_files</span><span class="p">)</span>
                <span class="n">v_zombies_data</span><span class="p">[</span><span class="s1">&#39;LIST_PARQUETS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_zombies_files</span>
                <span class="n">v_matches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v_zombies_data</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">v_matches</span><span class="p">)</span>

        <span class="n">v_start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">v_return</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">v_request</span> <span class="o">=</span> <span class="s2">&quot;Gather Bronze tables stats for </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_bronze_database_name</span><span class="p">())</span>
        <span class="n">v_log_message</span> <span class="o">=</span> <span class="s2">&quot;Starting &quot;</span><span class="o">+</span> <span class="n">v_request</span>
        <span class="k">if</span> <span class="n">p_verbose</span><span class="p">:</span>
                <span class="n">p_verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span><span class="s2">&quot;GATHER_BRONZE_STATS&quot;</span><span class="p">,</span><span class="s2">&quot;START&quot;</span><span class="p">,</span><span class="n">log_message</span><span class="o">=</span><span class="n">v_log_message</span><span class="p">)</span>
        <span class="c1"># check if options for garbage are set</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_garbage_options</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__init_garbage_options__</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Execute PLSQL Proc to gather informations of tables (uri for external tables)</span>
            <span class="n">v_log_message</span> <span class="o">=</span> <span class="s2">&quot;Gather Bronze tables stats with PL SQL Proc </span><span class="si">{0}</span><span class="s2">(</span><span class="si">{1}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gather_lh2_tables_stats_proc</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">gather_lh2_tables_stats_proc_args</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">p_verbose</span><span class="p">:</span>
                    <span class="n">p_verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span><span class="s2">&quot;GATHER_BRONZE_STATS&quot;</span><span class="p">,</span><span class="s2">&quot;START&quot;</span><span class="p">,</span><span class="n">log_message</span><span class="o">=</span><span class="n">v_log_message</span><span class="p">)</span>
            <span class="n">v_result_run_proc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_proc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gather_lh2_tables_stats_proc</span><span class="p">,</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">gather_lh2_tables_stats_proc_args</span><span class="p">,</span><span class="n">p_verbose</span><span class="o">=</span><span class="n">p_verbose</span><span class="p">,</span><span class="n">p_proc_exe_context</span><span class="o">=</span><span class="s1">&#39;ALL&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">v_result_run_proc</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ERROR, Executing Procedure </span><span class="si">{0}</span><span class="s2">(</span><span class="si">{1}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gather_lh2_tables_stats_proc</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">gather_lh2_tables_stats_proc_args</span><span class="p">))</span>
            
            <span class="c1"># Execute a SQL query to fetch list of external tables of bronze layer</span>
            <span class="n">v_cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db_connection</span><span class="p">()</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="n">v_sql</span> <span class="o">=</span> <span class="s2">&quot;select * from &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">lh2_tables_tablename</span> <span class="o">+</span> <span class="s2">&quot; WHERE ENV = </span><span class="se">\&#39;</span><span class="s2">&quot;</span><span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronzeDbManager_env</span> <span class="o">+</span><span class="s2">&quot;</span><span class="se">\&#39;</span><span class="s2"> AND TABLE_TYPE like </span><span class="se">\&#39;</span><span class="s2">External%</span><span class="se">\&#39;</span><span class="s2"> ORDER BY OWNER,TABLE_NAME&quot;</span>
            <span class="n">v_log_message</span> <span class="o">=</span> <span class="s2">&quot;Fetch list of external tables of bronze layer </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_sql</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">p_verbose</span><span class="p">:</span>
                    <span class="n">p_verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span><span class="s2">&quot;GATHER_BRONZE_STATS&quot;</span><span class="p">,</span><span class="s2">&quot;RUNNING&quot;</span><span class="p">,</span><span class="n">log_message</span><span class="o">=</span><span class="n">v_log_message</span><span class="p">)</span>
            <span class="n">v_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">v_sql</span><span class="p">)</span>
            <span class="n">v_df_lh2_tables</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">v_cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
            <span class="n">v_df_lh2_tables</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v_cursor</span><span class="o">.</span><span class="n">description</span><span class="p">]</span>
            <span class="n">v_cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="c1"># test if need to refresh parquet files stats</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">p_refresh_stats</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df_bronze_tables_stats</span> <span class="o">=</span> <span class="n">v_df_lh2_tables</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p_count_rows</span><span class="p">:</span>
                    <span class="c1"># count rows for each tables </span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    v_message = &quot;Count rows for  list of external tables of bronze layer {}&quot;.format(self.bronzeDbManager_env)</span>
<span class="sd">                    if p_verbose:</span>
<span class="sd">                        p_verbose.log(datetime.now(tz=timezone.utc),&quot;GATHER_BRONZE_STATS&quot;,&quot;RUNNING&quot;,log_message=v_message)</span>
<span class="sd">                    &quot;&quot;&quot;</span>
                    <span class="k">for</span> <span class="n">v_index</span><span class="p">,</span> <span class="n">v_row</span> <span class="ow">in</span> <span class="n">v_df_lh2_tables</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                        <span class="n">v_table_data</span> <span class="o">=</span> <span class="n">v_row</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
                        <span class="n">v_table_name</span> <span class="o">=</span> <span class="n">v_table_data</span><span class="p">[</span><span class="s1">&#39;TABLE_NAME&#39;</span><span class="p">]</span>
                        <span class="n">v_num_rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">()</span><span class="o">.</span><span class="n">get_num_rows</span><span class="p">(</span><span class="n">v_table_name</span><span class="p">)</span>
                        <span class="c1">#v_num_rows = 0</span>
                        <span class="n">v_df_lh2_tables</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">v_index</span><span class="p">,</span><span class="s1">&#39;NUM_ROWS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_num_rows</span>
                
                <span class="c1"># Get buckets used for bronze layers</span>
                <span class="c1"># Get distinct bucket names from the column</span>
                <span class="n">v_bronze_buckets_array</span> <span class="o">=</span> <span class="n">v_df_lh2_tables</span><span class="p">[</span><span class="s1">&#39;BUCKET&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
                <span class="c1"># Create a new DataFrame from the distinct values</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df_bronze_buckets_parquets</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">v_bronze_buckets_array</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;BUCKET&#39;</span><span class="p">])</span>
                <span class="c1"># Add a column &#39;LIST_PARQUETS&#39; with default values (here, empty lists)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df_bronze_buckets_parquets</span><span class="p">[</span><span class="s1">&#39;BUCKET_LIST_PARQUETS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_bronze_buckets_parquets</span><span class="p">))]</span>
                
                <span class="n">v_log_message</span> <span class="o">=</span> <span class="s2">&quot;Buckets used into bronze layer </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_bronze_buckets_parquets</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">p_verbose</span><span class="p">:</span>
                        <span class="n">p_verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span><span class="s2">&quot;GATHER_BRONZE_STATS&quot;</span><span class="p">,</span><span class="s2">&quot;RUNNING&quot;</span><span class="p">,</span><span class="n">log_message</span><span class="o">=</span><span class="n">v_log_message</span><span class="p">)</span>
                
                <span class="n">v_bronze_bucket_proxy</span> <span class="o">=</span> <span class="n">BronzeBucketProxy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bronzeDbManager_env</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bronzeDb_Manager_config</span><span class="p">)</span>
                <span class="c1"># Iterate over the &#39;BUCKET&#39; column and change the value of &#39;LIST_PARQUETS&#39; with list of objects name into each bucket</span>
                <span class="k">for</span> <span class="n">v_index</span><span class="p">,</span> <span class="n">v_row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_bronze_buckets_parquets</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                    <span class="n">v_bucket_name</span> <span class="o">=</span> <span class="n">v_row</span><span class="p">[</span><span class="s1">&#39;BUCKET&#39;</span><span class="p">]</span>
                    <span class="n">v_bronze_bucket_proxy</span><span class="o">.</span><span class="n">set_bucket_by_name</span><span class="p">(</span><span class="n">v_bucket_name</span><span class="p">)</span>
                    <span class="n">v_bucket</span><span class="p">:</span><span class="n">AbsBucket</span> <span class="o">=</span> <span class="n">v_bronze_bucket_proxy</span><span class="o">.</span><span class="n">get_bucket</span><span class="p">()</span>
                    <span class="n">v_bucket_list_objects</span> <span class="o">=</span> <span class="n">v_bucket</span><span class="o">.</span><span class="n">list_objects</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">df_bronze_buckets_parquets</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">v_index</span><span class="p">,</span> <span class="s1">&#39;BUCKET_LIST_PARQUETS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="n">o</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="s1">&#39;size_mb&#39;</span><span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">size</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="mi">1024</span><span class="p">}</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">v_bucket_list_objects</span><span class="p">]</span>
        
                <span class="n">v_log_message</span> <span class="o">=</span> <span class="s2">&quot;Bucket files inventory done </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_bronze_buckets_parquets</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">p_verbose</span><span class="p">:</span>
                        <span class="n">p_verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span><span class="s2">&quot;GATHER_BRONZE_STATS&quot;</span><span class="p">,</span><span class="s2">&quot;RUNNING&quot;</span><span class="p">,</span><span class="n">log_message</span><span class="o">=</span><span class="n">v_log_message</span><span class="p">)</span>
                        
                <span class="c1"># iterate Buckets and check for each external tables associated to the bucket, which bucket files are associated to the table</span>
                <span class="c1"># Bucket files not associated to any table, will associated to a &quot;zombies&quot; table        </span>
                <span class="n">v_df_updated_tables_stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">v_index</span><span class="p">,</span><span class="n">v_row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_bronze_buckets_parquets</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                    <span class="n">v_bucket_name</span> <span class="o">=</span> <span class="n">v_row</span><span class="p">[</span><span class="s1">&#39;BUCKET&#39;</span><span class="p">]</span>
                    <span class="n">v_df_bucket_tables</span> <span class="o">=</span> <span class="n">v_df_lh2_tables</span><span class="p">[</span><span class="n">v_df_lh2_tables</span><span class="p">[</span><span class="s1">&#39;BUCKET&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">v_bucket_name</span><span class="p">]</span>
                    <span class="n">v_log_message</span> <span class="o">=</span> <span class="s2">&quot;Check which files of bucket </span><span class="si">{0}</span><span class="s2"> are associated to external tables.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_bucket_name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">p_verbose</span><span class="p">:</span>
                        <span class="n">p_verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span><span class="s2">&quot;GATHER_BRONZE_STATS&quot;</span><span class="p">,</span><span class="s2">&quot;RUNNING&quot;</span><span class="p">,</span><span class="n">log_message</span><span class="o">=</span><span class="n">v_log_message</span><span class="p">)</span>
                    <span class="n">v_df_updated_bucket_tables</span> <span class="o">=</span> <span class="n">__match_files_to_tables__</span><span class="p">(</span><span class="n">v_df_bucket_tables</span><span class="p">,</span><span class="n">v_row</span><span class="p">[</span><span class="s1">&#39;BUCKET_LIST_PARQUETS&#39;</span><span class="p">])</span>
                    <span class="n">v_df_updated_tables_stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">v_df_updated_tables_stats</span><span class="p">,</span><span class="n">v_df_updated_bucket_tables</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df_bronze_tables_stats</span> <span class="o">=</span> <span class="n">v_df_updated_tables_stats</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gather_lh2_bronze_tables_stats_status</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">v_log_message</span> <span class="o">=</span> <span class="s2">&quot;Files are associated to external tables&quot;</span>
                <span class="k">if</span> <span class="n">p_verbose</span><span class="p">:</span>
                    <span class="n">p_verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span><span class="s2">&quot;GATHER_BRONZE_STATS&quot;</span><span class="p">,</span><span class="s2">&quot;END&quot;</span><span class="p">,</span><span class="n">log_message</span><span class="o">=</span><span class="n">v_log_message</span><span class="p">)</span>
            
            <span class="c1"># end of gather process    </span>
            <span class="n">v_log_message</span> <span class="o">=</span> <span class="s2">&quot;COMPLETED - &quot;</span> <span class="o">+</span> <span class="n">v_request</span>
            <span class="n">v_action</span> <span class="o">=</span> <span class="s2">&quot;COMPLETED&quot;</span>
            <span class="n">v_err</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">v_return</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">v_err</span> <span class="o">=</span> <span class="n">err</span>
            <span class="n">v_action</span> <span class="o">=</span> <span class="s2">&quot;ERROR - &quot;</span> <span class="o">+</span> <span class="n">v_request</span>
            <span class="n">v_log_message</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">v_err</span><span class="p">)</span>
            <span class="n">v_return</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="n">v_duration</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">v_start</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bronzeDb_Manager_logger</span><span class="o">.</span><span class="n">set_logger_properties</span><span class="p">(</span><span class="n">p_src_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_bronze_database_name</span><span class="p">(),</span><span class="n">p_src_origin_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_db_username</span><span class="p">(),</span><span class="n">p_src_object_name</span><span class="o">=</span><span class="s2">&quot;ALL&quot;</span><span class="p">,</span><span class="n">p_request</span><span class="o">=</span><span class="n">v_request</span><span class="p">,</span><span class="n">p_duration</span><span class="o">=</span><span class="n">v_duration</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">p_verbose</span><span class="p">:</span>
                    <span class="n">p_verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;GATHER_BRONZE_STATS&quot;</span><span class="p">,</span> <span class="n">v_action</span><span class="p">,</span> <span class="n">log_message</span><span class="o">=</span><span class="n">v_log_message</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bronzeDb_Manager_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pError</span><span class="o">=</span><span class="n">v_err</span><span class="p">,</span> <span class="n">pAction</span><span class="o">=</span><span class="n">v_action</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">v_return</span></div>

    
<div class="viewcode-block" id="BronzeDbManager.update_lh2_bronze_tables_stats">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeDbManager.update_lh2_bronze_tables_stats">[docs]</a>
    <span class="k">def</span> <span class="nf">update_lh2_bronze_tables_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p_verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># update databse LH2_tables with updated stats</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_gather_lh2_tables_stats_status</span><span class="p">():</span>
            <span class="n">v_log_message</span> <span class="o">=</span> <span class="s2">&quot;Need to refresh stats before update LH2 Bronze table stats &quot;</span>
            <span class="k">if</span> <span class="n">p_verbose</span><span class="p">:</span>
                <span class="n">p_verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;UPDATE_BRONZE_STATS&quot;</span><span class="p">,</span><span class="s2">&quot;START&quot;</span><span class="p">,</span><span class="n">log_message</span><span class="o">=</span><span class="n">v_log_message</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">v_start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">v_return</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">v_request</span> <span class="o">=</span> <span class="s2">&quot;Update external tables stats of bronze layer </span><span class="si">{}</span><span class="s2"> into table </span><span class="si">{}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bronzeDbManager_env</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">lh2_tables_tablename</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">v_log_message</span> <span class="o">=</span> <span class="s2">&quot;Starting &quot;</span><span class="o">+</span><span class="n">v_request</span>
            <span class="k">if</span> <span class="n">p_verbose</span><span class="p">:</span>
                <span class="n">p_verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span><span class="s2">&quot;UPDATE_BRONZE_STATS&quot;</span><span class="p">,</span><span class="s2">&quot;START&quot;</span><span class="p">,</span><span class="n">log_message</span><span class="o">=</span><span class="n">v_log_message</span><span class="p">)</span>
            <span class="n">v_cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db_connection</span><span class="p">()</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="n">v_filtered_df_lh2_bronze_tables</span> <span class="o">=</span> <span class="n">create_filter_mask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_lh2_bronze_tables_stats</span><span class="p">(),</span><span class="sa">f</span><span class="s1">&#39;TABLE_NAME != </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">ZOMBIES_TABLE_NAME</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">v_index</span><span class="p">,</span> <span class="n">v_row</span> <span class="ow">in</span> <span class="n">v_filtered_df_lh2_bronze_tables</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="n">v_rown_list_parquets</span> <span class="o">=</span> <span class="n">list_to_string</span><span class="p">(</span><span class="n">v_row</span><span class="p">[</span><span class="s1">&#39;LIST_PARQUETS&#39;</span><span class="p">])</span>
                <span class="n">v_sql</span> <span class="o">=</span> <span class="s2">&quot;UPDATE &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">lh2_tables_tablename</span> <span class="o">+</span> <span class="s2">&quot; SET NUM_ROWS = :1, SIZE_MB = :2, NUM_PARQUETS = :3, LIST_PARQUETS = :4 WHERE OWNER = :5 AND TABLE_NAME = :6&quot;</span>
                <span class="n">v_bindvars</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">v_row</span><span class="p">[</span><span class="s1">&#39;NUM_ROWS&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">v_row</span><span class="p">[</span><span class="s1">&#39;SIZE_MB&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">v_row</span><span class="p">[</span><span class="s1">&#39;NUM_PARQUETS&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">),</span><span class="n">v_rown_list_parquets</span><span class="p">,</span> <span class="n">v_row</span><span class="p">[</span><span class="s1">&#39;OWNER&#39;</span><span class="p">],</span> <span class="n">v_row</span><span class="p">[</span><span class="s1">&#39;TABLE_NAME&#39;</span><span class="p">])</span>
<span class="w">                </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">                v_log_message = &quot;Updating {0}.{1}, num_rows {2}, size_mb {3}, num_parquets {4}\n Request : {5}&quot;.format(v_row[&#39;OWNER&#39;], v_row[&#39;TABLE_NAME&#39;],int(v_row[&#39;NUM_ROWS&#39;] or 0), int(v_row[&#39;SIZE_MB&#39;] or 0), int(v_row[&#39;NUM_PARQUETS&#39;] or 0),v_sql)</span>
<span class="sd">                </span>
<span class="sd">                if p_verbose:</span>
<span class="sd">                    p_verbose.log(datetime.now(tz=timezone.utc),&quot;UPDATE_BRONZE_STATS&quot;,&quot;RUNNING&quot;,log_message=v_log_message)</span>
<span class="sd">                &#39;&#39;&#39;</span>
                <span class="n">v_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">v_sql</span><span class="p">,</span><span class="n">v_bindvars</span> <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">get_db_connection</span><span class="p">()</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="n">v_cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
           
            <span class="n">v_log_message</span> <span class="o">=</span> <span class="s2">&quot;COMPLETED - &quot;</span> <span class="o">+</span> <span class="n">v_request</span>
            <span class="n">v_action</span> <span class="o">=</span> <span class="s2">&quot;COMPLETED&quot;</span>
            <span class="n">v_err</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">v_return</span> <span class="o">=</span> <span class="kc">True</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">v_err</span> <span class="o">=</span> <span class="n">err</span>
            <span class="n">v_action</span> <span class="o">=</span> <span class="s2">&quot;ERROR - Update external tables stats of bronze layer </span><span class="si">{}</span><span class="s2"> into table </span><span class="si">{}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bronzeDbManager_env</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">lh2_tables_tablename</span><span class="p">)</span>
            <span class="n">v_log_message</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">v_err</span><span class="p">)</span>
            <span class="n">v_return</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="n">v_duration</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">v_start</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bronzeDb_Manager_logger</span><span class="o">.</span><span class="n">set_logger_properties</span><span class="p">(</span><span class="n">p_src_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_bronze_database_name</span><span class="p">(),</span><span class="n">p_src_origin_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_db_username</span><span class="p">(),</span><span class="n">p_src_object_name</span><span class="o">=</span><span class="s2">&quot;ALL&quot;</span><span class="p">,</span><span class="n">p_request</span><span class="o">=</span><span class="n">v_request</span><span class="p">,</span><span class="n">p_duration</span><span class="o">=</span><span class="n">v_duration</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">p_verbose</span><span class="p">:</span>
                    <span class="n">p_verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;UPDATE_TABLE_BRONZE_STATS&quot;</span><span class="p">,</span> <span class="n">v_action</span><span class="p">,</span> <span class="n">log_message</span><span class="o">=</span><span class="n">v_log_message</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bronzeDb_Manager_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pError</span><span class="o">=</span><span class="n">v_err</span><span class="p">,</span> <span class="n">pAction</span><span class="o">=</span><span class="n">v_action</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">v_return</span></div>

        
<div class="viewcode-block" id="BronzeDbManager.to_excel_lh2_bronze_tables_stats">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeDbManager.to_excel_lh2_bronze_tables_stats">[docs]</a>
    <span class="k">def</span> <span class="nf">to_excel_lh2_bronze_tables_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p_excel_filename</span><span class="o">=</span><span class="s2">&quot;lh2_bronze_tables_stats.xlsx&quot;</span><span class="p">,</span><span class="n">p_verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1">#Export LH2 bronze tables stats to Excel file</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_gather_lh2_tables_stats_status</span><span class="p">():</span>
            <span class="n">v_log_message</span> <span class="o">=</span> <span class="s2">&quot;Need to refresh stats before laucnh garbage collector &quot;</span>
            <span class="k">if</span> <span class="n">p_verbose</span><span class="p">:</span>
                <span class="n">p_verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;EXPORT_BRONZE_STATS&quot;</span><span class="p">,</span><span class="s2">&quot;START&quot;</span><span class="p">,</span><span class="n">log_message</span><span class="o">=</span><span class="n">v_log_message</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">v_start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">v_return</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">v_excel_file_tmp</span> <span class="o">=</span> <span class="n">p_excel_filename</span>
        <span class="n">v_request</span> <span class="o">=</span> <span class="s2">&quot;Exporting to temporay Excel file </span><span class="si">{}</span><span class="s2"> :&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_excel_file_tmp</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Create access to filestorage where to export excel file</span>
            <span class="n">v_filestorage_param</span> <span class="o">=</span> <span class="n">get_parser_config_settings</span><span class="p">(</span><span class="s2">&quot;filestorage&quot;</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">bronzeDb_Manager_config</span><span class="o">.</span><span class="n">get_configuration_file</span><span class="p">(),</span><span class="bp">self</span><span class="o">.</span><span class="n">filestorage_for_excel_export</span><span class="p">)</span>
            <span class="n">v_filestorage</span> <span class="o">=</span> <span class="n">FILESTORAGEFACTORY</span><span class="o">.</span><span class="n">create_instance</span><span class="p">(</span><span class="n">v_filestorage_param</span><span class="o">.</span><span class="n">filestorage_wrapper</span><span class="p">,</span><span class="o">**</span><span class="n">v_filestorage_param</span><span class="o">.</span><span class="n">_asdict</span><span class="p">())</span>
           
            <span class="c1"># Export dataframe to local Excel file</span>
            <span class="n">v_excel_file_tmp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bronzeDb_Manager_config</span><span class="o">.</span><span class="n">get_tempdir</span><span class="p">(),</span><span class="s1">&#39;tmp_&#39;</span><span class="o">+</span><span class="n">p_excel_filename</span><span class="p">)</span>
            <span class="n">v_log_message</span> <span class="o">=</span> <span class="n">v_request</span>
            <span class="k">if</span> <span class="n">p_verbose</span><span class="p">:</span>
                <span class="n">p_verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;EXPORT_BRONZE_STATS&quot;</span><span class="p">,</span><span class="s2">&quot;START&quot;</span><span class="p">,</span><span class="n">log_message</span><span class="o">=</span><span class="n">v_log_message</span><span class="p">)</span>
            <span class="n">v_df_converted_lists_to_strings</span> <span class="o">=</span> <span class="n">df_convert_lists_to_strings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_lh2_bronze_tables_stats</span><span class="p">())</span>
            <span class="n">v_df_converted_lists_to_strings</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">v_excel_file_tmp</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            
            <span class="c1"># copy generated Excel to filestorage</span>
            <span class="n">v_log_message</span> <span class="o">=</span> <span class="s2">&quot;Copy temporay Excel file </span><span class="si">{}</span><span class="s2"> -&gt; </span><span class="si">{}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_excel_file_tmp</span><span class="p">,</span><span class="n">v_filestorage</span><span class="o">.</span><span class="n">get_filestorage_name</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">p_verbose</span><span class="p">:</span>
                <span class="n">p_verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;EXPORT_BRONZE_STATS&quot;</span><span class="p">,</span> <span class="s2">&quot;RUNNING&quot;</span><span class="p">,</span><span class="n">log_message</span><span class="o">=</span><span class="n">v_log_message</span><span class="p">)</span>
            <span class="n">v_destination_excel_file</span> <span class="o">=</span> <span class="n">v_filestorage</span><span class="o">.</span><span class="n">put_file</span><span class="p">(</span><span class="n">p_excel_filename</span><span class="p">,</span><span class="n">v_excel_file_tmp</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">v_excel_file_tmp</span><span class="p">)</span>
            
            <span class="n">v_request</span> <span class="o">=</span> <span class="s2">&quot;Export Excel file </span><span class="si">{}</span><span class="s2"> :&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_destination_excel_file</span><span class="p">)</span>
            <span class="n">v_log_message</span> <span class="o">=</span> <span class="s2">&quot;COMPLETED - &quot;</span><span class="o">+</span><span class="n">v_request</span>
            <span class="n">v_action</span> <span class="o">=</span> <span class="s2">&quot;COMPLETED&quot;</span>
            <span class="n">v_err</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">v_return</span> <span class="o">=</span> <span class="n">v_destination_excel_file</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">v_err</span> <span class="o">=</span> <span class="n">err</span>
            <span class="n">v_action</span> <span class="o">=</span> <span class="s2">&quot;ERROR  - &quot;</span> <span class="o">+</span> <span class="n">v_request</span>
            <span class="n">v_log_message</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">v_err</span><span class="p">)</span>
            <span class="n">v_return</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="n">v_duration</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">v_start</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bronzeDb_Manager_logger</span><span class="o">.</span><span class="n">set_logger_properties</span><span class="p">(</span><span class="n">p_src_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_bronze_database_name</span><span class="p">(),</span><span class="n">p_src_origin_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_db_username</span><span class="p">(),</span><span class="n">p_src_object_name</span><span class="o">=</span><span class="s2">&quot;ALL&quot;</span><span class="p">,</span><span class="n">p_request</span><span class="o">=</span><span class="n">v_request</span><span class="p">,</span><span class="n">p_duration</span><span class="o">=</span><span class="n">v_duration</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">p_verbose</span><span class="p">:</span>
                    <span class="n">p_verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;EXPORT_BRONZE_STATS&quot;</span><span class="p">,</span> <span class="n">v_action</span><span class="p">,</span> <span class="n">log_message</span><span class="o">=</span><span class="n">v_log_message</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bronzeDb_Manager_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pError</span><span class="o">=</span><span class="n">v_err</span><span class="p">,</span> <span class="n">pAction</span><span class="o">=</span><span class="n">v_action</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">v_return</span></div>

        

    <span class="k">def</span> <span class="nf">__delete_parquet_files__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p_bucket_name</span><span class="p">,</span><span class="n">p_parquet_list</span><span class="p">,</span><span class="n">p_simulate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">p_verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Into bucket, Drop list of parquets files</span>
        <span class="n">v_start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">v_return</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">v_file</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">v_request</span> <span class="o">=</span> <span class="s2">&quot;Into bucket </span><span class="si">{}</span><span class="s2">, Simulate </span><span class="si">{}</span><span class="s2"> </span><span class="se">\n</span><span class="s2"> Deleting </span><span class="si">{}</span><span class="s2"> parquet files : </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_bucket_name</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">p_simulate</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">p_parquet_list</span><span class="p">),</span><span class="n">p_parquet_list</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">v_log_message</span> <span class="o">=</span> <span class="n">v_request</span>
            <span class="k">if</span> <span class="n">p_verbose</span><span class="p">:</span>
                <span class="n">p_verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;DELETE_PARQUETS&quot;</span><span class="p">,</span><span class="s2">&quot;START&quot;</span><span class="p">,</span><span class="n">log_message</span><span class="o">=</span><span class="n">v_log_message</span><span class="p">)</span>
            <span class="n">v_bronze_bucket_proxy</span> <span class="o">=</span> <span class="n">BronzeBucketProxy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bronzeDbManager_env</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bronzeDb_Manager_config</span><span class="p">)</span>
            <span class="n">v_bronze_bucket_proxy</span><span class="o">.</span><span class="n">set_bucket_by_name</span><span class="p">(</span><span class="n">p_bucket_name</span><span class="p">)</span>
            <span class="n">v_bucket</span><span class="p">:</span><span class="n">AbsBucket</span> <span class="o">=</span> <span class="n">v_bronze_bucket_proxy</span><span class="o">.</span><span class="n">get_bucket</span><span class="p">()</span>
            <span class="c1"># Iterate parquet list and delete object into bucket</span>
            <span class="k">for</span> <span class="n">v_object</span> <span class="ow">in</span> <span class="n">p_parquet_list</span><span class="p">:</span>
                <span class="n">v_file</span> <span class="o">=</span> <span class="n">v_object</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">p_simulate</span><span class="p">:</span>
                    <span class="n">v_bucket</span><span class="o">.</span><span class="n">delete_object</span><span class="p">(</span><span class="n">v_object</span><span class="p">)</span>
            
            <span class="n">v_log_message</span> <span class="o">=</span> <span class="s2">&quot;COMLPLETED - &quot;</span><span class="o">+</span> <span class="n">v_request</span>
            <span class="n">v_action</span> <span class="o">=</span> <span class="s2">&quot;COMPLETED&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">p_simulate</span> <span class="k">else</span> <span class="s2">&quot;COMPLETED - SIMULATE&quot;</span>
            <span class="n">v_err</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">v_return</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">v_err</span> <span class="o">=</span> <span class="n">err</span>
            <span class="n">v_action</span> <span class="o">=</span> <span class="s2">&quot;ERROR - Into bucket </span><span class="si">{}</span><span class="s2">, can not drop parquet file </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_bucket_name</span><span class="p">,</span><span class="n">v_file</span><span class="p">)</span>
            <span class="n">v_log_message</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">v_err</span><span class="p">)</span>
            <span class="n">v_return</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="n">v_duration</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">v_start</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bronzeDb_Manager_logger</span><span class="o">.</span><span class="n">set_logger_properties</span><span class="p">(</span><span class="n">p_src_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_bronze_database_name</span><span class="p">(),</span><span class="n">p_src_origin_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_db_username</span><span class="p">(),</span><span class="n">p_src_object_name</span><span class="o">=</span><span class="n">p_bucket_name</span><span class="p">,</span><span class="n">p_request</span><span class="o">=</span><span class="n">v_request</span><span class="p">,</span><span class="n">p_duration</span><span class="o">=</span><span class="n">v_duration</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">p_verbose</span><span class="p">:</span>
                    <span class="n">p_verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;DELETE_PARQUETS&quot;</span><span class="p">,</span> <span class="n">v_action</span><span class="p">,</span> <span class="n">log_message</span><span class="o">=</span><span class="n">v_log_message</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bronzeDb_Manager_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pError</span><span class="o">=</span><span class="n">v_err</span><span class="p">,</span> <span class="n">pAction</span><span class="o">=</span><span class="n">v_action</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">v_return</span>

    
<div class="viewcode-block" id="BronzeDbManager.bronze_garbage_collector">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeDbManager.bronze_garbage_collector">[docs]</a>
    <span class="k">def</span> <span class="nf">bronze_garbage_collector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p_simulate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">p_verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1">#Garbage collector to delete parquet files not associated to any external tables (zombies parquet files)</span>
        <span class="n">v_start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">v_return</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">v_request</span> <span class="o">=</span> <span class="s2">&quot;Garbage collector for </span><span class="si">{}</span><span class="s2"> - Simulate </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bronzeDbManager_env</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">p_simulate</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_gather_lh2_tables_stats_status</span><span class="p">():</span>
            <span class="n">v_log_message</span> <span class="o">=</span> <span class="s2">&quot;Need to refresh stats before laucnh garbage collector &quot;</span>
            <span class="k">if</span> <span class="n">p_verbose</span><span class="p">:</span>
                <span class="n">p_verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;GARBAGE_COLLECTOR&quot;</span><span class="p">,</span><span class="s2">&quot;START&quot;</span><span class="p">,</span><span class="n">log_message</span><span class="o">=</span><span class="n">v_log_message</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">v_log_message</span> <span class="o">=</span> <span class="s2">&quot;Starting &quot;</span><span class="o">+</span> <span class="n">v_request</span>
            <span class="k">if</span> <span class="n">p_verbose</span><span class="p">:</span>
                <span class="n">p_verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;GARBAGE_COLLECTOR&quot;</span><span class="p">,</span><span class="s2">&quot;START&quot;</span><span class="p">,</span><span class="n">log_message</span><span class="o">=</span><span class="n">v_log_message</span><span class="p">)</span>
            <span class="c1"># Filter on ZOMBIES TABLE</span>
            <span class="n">v_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_bronze_tables_stats</span><span class="p">[</span><span class="s1">&#39;TABLE_NAME&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ZOMBIES_TABLE_NAME</span>
            <span class="k">for</span> <span class="n">v_index</span><span class="p">,</span><span class="n">v_row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_bronze_tables_stats</span><span class="p">[</span><span class="n">v_mask</span><span class="p">]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="n">v_bucket_name</span> <span class="o">=</span> <span class="n">v_row</span><span class="p">[</span><span class="s1">&#39;BUCKET&#39;</span><span class="p">]</span>
                <span class="n">v_parquet_list</span> <span class="o">=</span> <span class="n">v_row</span><span class="p">[</span><span class="s1">&#39;LIST_PARQUETS&#39;</span><span class="p">]</span>
                <span class="n">v_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__delete_parquet_files__</span><span class="p">(</span><span class="n">p_bucket_name</span><span class="o">=</span><span class="n">v_bucket_name</span><span class="p">,</span><span class="n">p_parquet_list</span><span class="o">=</span><span class="n">v_parquet_list</span><span class="p">,</span><span class="n">p_simulate</span><span class="o">=</span><span class="n">p_simulate</span><span class="p">,</span><span class="n">p_verbose</span><span class="o">=</span><span class="n">p_verbose</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">v_result</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ERROR  Deleting parquet files into bucket </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_bucket_name</span><span class="p">))</span>
                
            <span class="n">v_log_message</span> <span class="o">=</span> <span class="s2">&quot;COMPLETED - &quot;</span> <span class="o">+</span> <span class="n">v_request</span>
            <span class="n">v_action</span> <span class="o">=</span> <span class="s2">&quot;COMPLETED&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">p_simulate</span> <span class="k">else</span> <span class="s2">&quot;COMPLETED - SIMULATE&quot;</span>
            <span class="n">v_err</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">v_return</span> <span class="o">=</span> <span class="kc">True</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">v_err</span> <span class="o">=</span> <span class="n">err</span>
            <span class="n">v_action</span> <span class="o">=</span> <span class="s2">&quot;ERROR - &quot;</span> <span class="o">+</span> <span class="n">v_request</span>
            <span class="n">v_log_message</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">v_err</span><span class="p">)</span>
            <span class="n">v_return</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="n">v_duration</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">v_start</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bronzeDb_Manager_logger</span><span class="o">.</span><span class="n">set_logger_properties</span><span class="p">(</span><span class="n">p_src_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_bronze_database_name</span><span class="p">(),</span><span class="n">p_src_origin_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_db_username</span><span class="p">(),</span><span class="n">p_src_object_name</span><span class="o">=</span><span class="s2">&quot;ALL&quot;</span><span class="p">,</span><span class="n">p_request</span><span class="o">=</span><span class="n">v_request</span><span class="p">,</span><span class="n">p_duration</span><span class="o">=</span><span class="n">v_duration</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">p_verbose</span><span class="p">:</span>
                    <span class="n">p_verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;GARBAGE_COLLECTOR&quot;</span><span class="p">,</span> <span class="n">v_action</span><span class="p">,</span> <span class="n">log_message</span><span class="o">=</span><span class="n">v_log_message</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bronzeDb_Manager_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pError</span><span class="o">=</span><span class="n">v_err</span><span class="p">,</span> <span class="n">pAction</span><span class="o">=</span><span class="n">v_action</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">v_return</span></div>

              
    
<div class="viewcode-block" id="BronzeDbManager.bronze_drop_table">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeDbManager.bronze_drop_table">[docs]</a>
    <span class="k">def</span> <span class="nf">bronze_drop_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p_table_name</span><span class="p">,</span><span class="n">p_simulate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">p_verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># drop bronze table : drop external table into database and delete associated parquet files</span>
        <span class="n">v_start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">v_return</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">v_request</span> <span class="o">=</span> <span class="s2">&quot;Drop table </span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2"> and associated parquet files - Simulate </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_db_username</span><span class="p">(),</span><span class="n">p_table_name</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">p_simulate</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_gather_lh2_tables_stats_status</span><span class="p">():</span>
            <span class="n">v_log_message</span> <span class="o">=</span> <span class="s2">&quot;Need to refresh stats before dropping table </span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_db_username</span><span class="p">(),</span><span class="n">p_table_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">p_verbose</span><span class="p">:</span>
                <span class="n">p_verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;DROP_TABLE&quot;</span><span class="p">,</span><span class="s2">&quot;START&quot;</span><span class="p">,</span><span class="n">log_message</span><span class="o">=</span><span class="n">v_log_message</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">v_log_message</span> <span class="o">=</span> <span class="s2">&quot;Starting </span><span class="si">{}</span><span class="s2"> - Simulate : </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_request</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">p_simulate</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">p_verbose</span><span class="p">:</span>
                <span class="n">p_verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;DROP_TABLE&quot;</span><span class="p">,</span><span class="s2">&quot;START&quot;</span><span class="p">,</span><span class="n">log_message</span><span class="o">=</span><span class="n">v_log_message</span><span class="p">)</span>
            <span class="c1"># Test if table exists</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_table_exists</span><span class="p">(</span><span class="n">p_table_name</span><span class="p">):</span>
                <span class="n">v_log_message</span> <span class="o">=</span> <span class="s2">&quot;Table </span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2"> does not exist &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_db_username</span><span class="p">(),</span><span class="n">p_table_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">p_verbose</span><span class="p">:</span>
                    <span class="n">p_verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;DROP_TABLE&quot;</span><span class="p">,</span><span class="s2">&quot;START&quot;</span><span class="p">,</span><span class="n">log_message</span><span class="o">=</span><span class="n">v_log_message</span><span class="p">)</span>
                <span class="n">v_log_message</span> <span class="o">=</span> <span class="s2">&quot;COMPLETED - &quot;</span><span class="o">+</span> <span class="n">v_request</span>
                <span class="n">v_action</span> <span class="o">=</span> <span class="s2">&quot;COMPLETED&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">p_simulate</span> <span class="k">else</span> <span class="s2">&quot;COMPLETED - SIMULATE&quot;</span> 
                <span class="n">v_err</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">v_return</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="c1"># Filter on table name  and ower = db user name</span>
            <span class="n">v_mask</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_bronze_tables_stats</span><span class="p">[</span><span class="s1">&#39;OWNER&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db_username</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_bronze_tables_stats</span><span class="p">[</span><span class="s1">&#39;TABLE_NAME&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">p_table_name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">v_index</span><span class="p">,</span><span class="n">v_row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_bronze_tables_stats</span><span class="p">[</span><span class="n">v_mask</span><span class="p">]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="c1"># Drop table into database</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">p_simulate</span><span class="p">:</span>
                    <span class="n">v_result_run_proc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_proc</span><span class="p">(</span><span class="s1">&#39;LH2_BRONZE_ADMIN_PKG.DROP_TABLE_PROC&#39;</span><span class="p">,</span><span class="o">*</span><span class="p">[</span><span class="n">p_table_name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bronzeDb_Manager_config</span><span class="o">.</span><span class="n">get_options</span><span class="p">()</span><span class="o">.</span><span class="n">bronze_bis_suffixe</span><span class="p">],</span><span class="n">p_verbose</span><span class="o">=</span><span class="n">p_verbose</span><span class="p">,</span><span class="n">p_proc_exe_context</span><span class="o">=</span><span class="n">p_table_name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">v_result_run_proc</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">v_result_run_proc</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ERROR dropping table </span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_db_username</span><span class="p">(),</span><span class="n">p_table_name</span><span class="p">))</span>
                
                <span class="c1"># delete associated parquets files</span>
                <span class="n">v_bucket_name</span> <span class="o">=</span> <span class="n">v_row</span><span class="p">[</span><span class="s1">&#39;BUCKET&#39;</span><span class="p">]</span>
                <span class="n">v_parquet_list</span> <span class="o">=</span> <span class="n">v_row</span><span class="p">[</span><span class="s1">&#39;LIST_PARQUETS&#39;</span><span class="p">]</span>
                <span class="n">v_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__delete_parquet_files__</span><span class="p">(</span><span class="n">p_bucket_name</span><span class="o">=</span><span class="n">v_bucket_name</span><span class="p">,</span><span class="n">p_parquet_list</span><span class="o">=</span><span class="n">v_parquet_list</span><span class="p">,</span><span class="n">p_simulate</span><span class="o">=</span><span class="n">p_simulate</span><span class="p">,</span><span class="n">p_verbose</span><span class="o">=</span><span class="n">p_verbose</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">v_result</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ERROR  Deleting parquet files into bucket </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_bucket_name</span><span class="p">))</span>
                
            <span class="n">v_log_message</span> <span class="o">=</span> <span class="s2">&quot;COMPLETED - &quot;</span><span class="o">+</span> <span class="n">v_request</span>
            <span class="n">v_action</span> <span class="o">=</span> <span class="s2">&quot;COMPLETED&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">p_simulate</span> <span class="k">else</span> <span class="s2">&quot;COMPLETED - SIMULATE&quot;</span> 
            <span class="n">v_err</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">v_return</span> <span class="o">=</span> <span class="kc">True</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">v_err</span> <span class="o">=</span> <span class="n">err</span>
            <span class="n">v_action</span> <span class="o">=</span> <span class="s2">&quot;ERROR - Drop table </span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2"> and associated parquet files&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_db_username</span><span class="p">(),</span><span class="n">p_table_name</span><span class="p">)</span>
            <span class="n">v_log_message</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">v_err</span><span class="p">)</span>
            <span class="n">v_return</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="n">v_duration</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">v_start</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bronzeDb_Manager_logger</span><span class="o">.</span><span class="n">set_logger_properties</span><span class="p">(</span><span class="n">p_src_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_bronze_database_name</span><span class="p">(),</span><span class="n">p_src_origin_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_db_username</span><span class="p">(),</span><span class="n">p_src_object_name</span><span class="o">=</span><span class="n">p_table_name</span><span class="p">,</span><span class="n">p_request</span><span class="o">=</span><span class="n">v_request</span><span class="p">,</span><span class="n">p_duration</span><span class="o">=</span><span class="n">v_duration</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">p_verbose</span><span class="p">:</span>
                    <span class="n">p_verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;DROP_EXTERANL_TABLE&quot;</span><span class="p">,</span> <span class="n">v_action</span><span class="p">,</span> <span class="n">log_message</span><span class="o">=</span><span class="n">v_log_message</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bronzeDb_Manager_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pError</span><span class="o">=</span><span class="n">v_err</span><span class="p">,</span> <span class="n">pAction</span><span class="o">=</span><span class="n">v_action</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">v_return</span></div>

       
<div class="viewcode-block" id="BronzeDbManager.bronze_drop_tables_by_query">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeDbManager.bronze_drop_tables_by_query">[docs]</a>
    <span class="k">def</span> <span class="nf">bronze_drop_tables_by_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p_query</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="n">p_bronze_exploit</span><span class="p">:</span><span class="n">BronzeExploit</span><span class="p">,</span><span class="n">p_simulate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">p_ask_to_drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">p_verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># drop bronze tables </span>
        <span class="c1"># list of tables return by query on dataframe df_lh2_tables_stats</span>
        <span class="n">v_start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">v_return</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">v_request</span> <span class="o">=</span> <span class="s2">&quot;Drop tables on query </span><span class="si">{}</span><span class="s2"> - Simulate </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_query</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">p_simulate</span><span class="p">))</span>
        <span class="n">v_table_list_to_drop</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_gather_lh2_tables_stats_status</span><span class="p">():</span>
            <span class="n">v_log_message</span> <span class="o">=</span> <span class="s2">&quot;Need to refresh stats before dropping tables with query </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_query</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">p_verbose</span><span class="p">:</span>
                <span class="n">p_verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;DROP_TABLES_QUERY&quot;</span><span class="p">,</span><span class="s2">&quot;START&quot;</span><span class="p">,</span><span class="n">log_message</span><span class="o">=</span><span class="n">v_log_message</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">v_log_message</span> <span class="o">=</span> <span class="s2">&quot;Starting &quot;</span> <span class="o">+</span> <span class="n">v_request</span>
            <span class="k">if</span> <span class="n">p_verbose</span><span class="p">:</span>
                <span class="n">p_verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;DROP_TABLES_QUERY&quot;</span><span class="p">,</span><span class="s2">&quot;START&quot;</span><span class="p">,</span><span class="n">log_message</span><span class="o">=</span><span class="n">v_log_message</span><span class="p">)</span>
            
            <span class="n">v_filtered_df_lh2_bronze_table_without_zombies</span> <span class="o">=</span> <span class="n">create_filter_mask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_lh2_bronze_tables_stats</span><span class="p">(),</span><span class="sa">f</span><span class="s1">&#39;TABLE_NAME != </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">ZOMBIES_TABLE_NAME</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">v_filtered_df_lh2_bronze_tables</span> <span class="o">=</span> <span class="n">create_filter_mask</span><span class="p">(</span><span class="n">v_filtered_df_lh2_bronze_table_without_zombies</span><span class="p">,</span><span class="n">p_query</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">v_filtered_df_lh2_bronze_tables</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v_filtered_df_lh2_bronze_tables</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ERROR, Filtering bronze tables list, review your drop query&quot;</span><span class="p">)</span>
            <span class="n">v_table_list_to_drop</span> <span class="o">=</span> <span class="n">v_filtered_df_lh2_bronze_tables</span><span class="p">[</span><span class="s1">&#39;TABLE_NAME&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">p_verbose</span><span class="p">:</span>
                <span class="n">v_log_message</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> tables to be dropped : </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v_table_list_to_drop</span><span class="p">),</span><span class="n">v_table_list_to_drop</span><span class="p">)</span>
                <span class="n">p_verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;DROP_TABLES_QUERY&quot;</span><span class="p">,</span> <span class="s2">&quot;RUNNING&quot;</span><span class="p">,</span> <span class="n">log_message</span><span class="o">=</span><span class="n">v_log_message</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">p_ask_to_drop</span><span class="p">:</span>
                <span class="n">v_user_ask_to_drop</span> <span class="o">=</span> <span class="n">ask_user</span><span class="p">(</span><span class="s2">&quot;Confirm to drop tables&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">v_user_ask_to_drop</span> <span class="o">==</span> <span class="s2">&quot;N&quot;</span><span class="p">:</span>
                    <span class="n">v_request</span> <span class="o">=</span> <span class="s2">&quot;Drop tables on query </span><span class="si">{}</span><span class="s2"> : </span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_query</span><span class="p">,</span><span class="n">v_table_list_to_drop</span><span class="p">)</span>
                    <span class="n">v_log_message</span> <span class="o">=</span> <span class="s2">&quot;COMPLETED - NOT CONFIRMED&quot;</span> <span class="o">+</span> <span class="n">v_request</span>
                    <span class="n">v_action</span> <span class="o">=</span> <span class="s2">&quot;COMPLETED&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">p_simulate</span> <span class="k">else</span> <span class="s2">&quot;COMPLETED - SIMULATE&quot;</span>
                    <span class="n">v_err</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">v_return</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span><span class="n">v_row</span> <span class="ow">in</span> <span class="n">v_filtered_df_lh2_bronze_tables</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="n">v_table_data</span> <span class="o">=</span> <span class="n">v_row</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
                <span class="n">v_table_name</span> <span class="o">=</span> <span class="n">v_table_data</span><span class="p">[</span><span class="s1">&#39;TABLE_NAME&#39;</span><span class="p">]</span>
                <span class="n">v_table_partitioned</span> <span class="o">=</span> <span class="n">v_table_data</span><span class="p">[</span><span class="s1">&#39;PARTITIONED&#39;</span><span class="p">]</span>
                <span class="n">v_drop_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronze_drop_table</span><span class="p">(</span><span class="n">p_table_name</span><span class="o">=</span><span class="n">v_table_name</span><span class="p">,</span><span class="n">p_simulate</span><span class="o">=</span><span class="n">p_simulate</span><span class="p">,</span><span class="n">p_verbose</span><span class="o">=</span><span class="n">p_verbose</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">v_drop_result</span><span class="p">:</span>
                    <span class="c1"># if drop table successfull, reset BRONZE_LASTUPLOADED_PARQUET , and SRC_DATE_LASTUPDATE to RESET_DATE_LASTUPDATE for Incremental table (Partitioned table)</span>
                    <span class="n">v_dict_update_exploit</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="n">v_dict_update_exploit</span><span class="p">[</span><span class="s1">&#39;bronze_lastuploaded_parquet&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span>
                    <span class="n">v_row_exploit</span> <span class="o">=</span> <span class="n">p_bronze_exploit</span><span class="p">[</span><span class="n">v_table_name</span><span class="p">]</span>
                    <span class="n">v_reset_date_lastupdate</span> <span class="o">=</span> <span class="n">v_row_exploit</span><span class="o">.</span><span class="n">reset_lastupdate</span>
                    <span class="n">v_dict_update_exploit</span><span class="p">[</span><span class="s1">&#39;last_update&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">v_reset_date_lastupdate</span>
                        
                    <span class="k">if</span> <span class="n">p_verbose</span><span class="p">:</span>
                        <span class="n">v_log_message</span> <span class="o">=</span> <span class="s2">&quot;Update Exploit loading table </span><span class="si">{}</span><span class="s2"> , reset </span><span class="si">{}</span><span class="s2"> - Simulate = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_table_name</span><span class="p">,</span><span class="n">v_dict_update_exploit</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">p_simulate</span><span class="p">))</span>
                        <span class="n">p_verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;DROP_TABLES_QUERY&quot;</span><span class="p">,</span> <span class="s2">&quot;RUNNING&quot;</span><span class="p">,</span> <span class="n">log_message</span><span class="o">=</span><span class="n">v_log_message</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">p_simulate</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">p_bronze_exploit</span><span class="o">.</span><span class="n">update_exploit</span><span class="p">(</span><span class="n">v_dict_update_exploit</span><span class="p">,</span><span class="n">p_bronze_table_name</span><span class="o">=</span><span class="n">v_table_name</span><span class="p">):</span>
                                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ERROR - Update Exploit table </span><span class="si">{}</span><span class="s2"> : </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_table_name</span><span class="p">,</span><span class="n">v_dict_update_exploit</span><span class="p">))</span> 
                
            <span class="n">v_request</span> <span class="o">=</span> <span class="s2">&quot;Drop tables on query </span><span class="si">{}</span><span class="s2"> : </span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_query</span><span class="p">,</span><span class="n">v_table_list_to_drop</span><span class="p">)</span>
            <span class="n">v_log_message</span> <span class="o">=</span> <span class="s2">&quot;COMPLETED - &quot;</span> <span class="o">+</span> <span class="n">v_request</span>
            <span class="n">v_action</span> <span class="o">=</span> <span class="s2">&quot;COMPLETED&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">p_simulate</span> <span class="k">else</span> <span class="s2">&quot;COMPLETED - SIMULATE&quot;</span>
            <span class="n">v_err</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">v_return</span> <span class="o">=</span> <span class="kc">True</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">v_err</span> <span class="o">=</span> <span class="n">err</span>
            <span class="n">v_action</span> <span class="o">=</span> <span class="s2">&quot;ERROR - Drop table - Drop tables on query </span><span class="si">{}</span><span class="s2"> : </span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_query</span><span class="p">,</span><span class="n">v_table_list_to_drop</span><span class="p">)</span>
            <span class="n">v_log_message</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">v_err</span><span class="p">)</span>
            <span class="n">v_return</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="n">v_duration</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">v_start</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bronzeDb_Manager_logger</span><span class="o">.</span><span class="n">set_logger_properties</span><span class="p">(</span><span class="n">p_src_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_bronze_database_name</span><span class="p">(),</span><span class="n">p_src_origin_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_db_username</span><span class="p">(),</span><span class="n">p_src_object_name</span><span class="o">=</span><span class="s2">&quot;ALL&quot;</span><span class="p">,</span><span class="n">p_request</span><span class="o">=</span><span class="n">v_request</span><span class="p">,</span><span class="n">p_duration</span><span class="o">=</span><span class="n">v_duration</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">p_verbose</span><span class="p">:</span>
                    <span class="n">p_verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;DROP_TABLES_QUERY&quot;</span><span class="p">,</span> <span class="n">v_action</span><span class="p">,</span> <span class="n">log_message</span><span class="o">=</span><span class="n">v_log_message</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bronzeDb_Manager_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pError</span><span class="o">=</span><span class="n">v_err</span><span class="p">,</span> <span class="n">pAction</span><span class="o">=</span><span class="n">v_action</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">v_return</span></div>
</div>

            
<div class="viewcode-block" id="BronzeBucketProxy">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeBucketProxy">[docs]</a>
<span class="k">class</span> <span class="nc">BronzeBucketProxy</span><span class="p">:</span>
    <span class="c1"># Class to provide a substitute to manage bronze bucket.</span>
    <span class="c1"># add actions to get settings informations to connect to bronze buckets (DEBUG, DEV, STG, PRD)</span>
    <span class="c1"># create OCIBUcket object to connect on</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p_env</span><span class="p">,</span><span class="n">p_bronze_config</span><span class="p">:</span><span class="n">BronzeConfig</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">p_env</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">bronze_config</span> <span class="o">=</span> <span class="n">p_bronze_config</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">==</span> <span class="s2">&quot;DEBUG&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oci_settings</span> <span class="o">=</span> <span class="n">get_parser_config_settings</span><span class="p">(</span><span class="s2">&quot;filestorage&quot;</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">bronze_config</span><span class="o">.</span><span class="n">get_configuration_file</span><span class="p">(),</span><span class="s2">&quot;BRONZE_BUCKET_DEBUG&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oci_settings</span> <span class="o">=</span> <span class="n">get_parser_config_settings</span><span class="p">(</span><span class="s2">&quot;filestorage&quot;</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">bronze_config</span><span class="o">.</span><span class="n">get_configuration_file</span><span class="p">(),</span><span class="s2">&quot;BRONZE_BUCKET&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bronze_bucket_settings</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span> <span class="o">=</span> <span class="kc">None</span>
            
<div class="viewcode-block" id="BronzeBucketProxy.set_bucket_by_extension">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeBucketProxy.set_bucket_by_extension">[docs]</a>
    <span class="k">def</span> <span class="nf">set_bucket_by_extension</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p_bucket_extension</span><span class="p">):</span>
        <span class="c1"># Define bucket name</span>
        <span class="n">v_bucket_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="n">v_bucket_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronze_config</span><span class="o">.</span><span class="n">get_oci_settings</span><span class="p">()</span><span class="o">.</span><span class="n">storage_name</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">p_bucket_extension</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">v_bucket_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronze_config</span><span class="o">.</span><span class="n">get_oci_settings</span><span class="p">()</span><span class="o">.</span><span class="n">storage_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_bucket_by_name</span><span class="p">(</span><span class="n">v_bucket_name</span><span class="p">)</span></div>

            
<div class="viewcode-block" id="BronzeBucketProxy.set_bucket_by_name">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeBucketProxy.set_bucket_by_name">[docs]</a>
    <span class="k">def</span> <span class="nf">set_bucket_by_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p_bucket_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bronze_bucket_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bronze_config</span><span class="o">.</span><span class="n">get_oci_settings</span><span class="p">()</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">storage_name</span><span class="o">=</span><span class="n">p_bucket_name</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        else:</span>
<span class="sd">            self.bronze_bucket_settings = type(self.bronze_config.get_oci_settings())._make(self.bronze_config.get_oci_settings())</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialize bucket when set a new storage name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="o">=</span> <span class="kc">None</span></div>

            
<div class="viewcode-block" id="BronzeBucketProxy.connect">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeBucketProxy.connect">[docs]</a>
    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bronze_bucket_settings</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span> <span class="o">=</span> <span class="n">FILESTORAGEFACTORY</span><span class="o">.</span><span class="n">create_instance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_bronze_bucket_settings</span><span class="p">()</span><span class="o">.</span><span class="n">filestorage_wrapper</span><span class="p">,</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">get_bronze_bucket_settings</span><span class="p">()</span><span class="o">.</span><span class="n">_asdict</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span></div>

    
<div class="viewcode-block" id="BronzeBucketProxy.get_bucket">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeBucketProxy.get_bucket">[docs]</a>
    <span class="k">def</span> <span class="nf">get_bucket</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span></div>

    
<div class="viewcode-block" id="BronzeBucketProxy.get_bronze_bucket_settings">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeBucketProxy.get_bronze_bucket_settings">[docs]</a>
    <span class="k">def</span> <span class="nf">get_bronze_bucket_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronze_bucket_settings</span></div>

    
<div class="viewcode-block" id="BronzeBucketProxy.get_bucket_name">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeBucketProxy.get_bucket_name">[docs]</a>
    <span class="k">def</span> <span class="nf">get_bucket_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bronze_bucket_settings</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronze_bucket_settings</span><span class="o">.</span><span class="n">storage_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

    
<div class="viewcode-block" id="BronzeBucketProxy.get_oci_objectstorage_url">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeBucketProxy.get_oci_objectstorage_url">[docs]</a>
    <span class="k">def</span> <span class="nf">get_oci_objectstorage_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bronze_bucket_settings</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronze_bucket_settings</span><span class="o">.</span><span class="n">url</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

    
<div class="viewcode-block" id="BronzeBucketProxy.get_oci_adw_credential">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeBucketProxy.get_oci_adw_credential">[docs]</a>
    <span class="k">def</span> <span class="nf">get_oci_adw_credential</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bronze_bucket_settings</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronze_bucket_settings</span><span class="o">.</span><span class="n">setting2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>
</div>

        
<div class="viewcode-block" id="BronzeSourceBuilder">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeSourceBuilder">[docs]</a>
<span class="k">class</span> <span class="nc">BronzeSourceBuilder</span><span class="p">:</span>
    <span class="c1"># ENV : environement DEV, STG, PRD</span>
    <span class="c1"># config_file : dictionary json config file with connection parameters</span>
    <span class="c1"># SRC_TYPE	Type of source	DB SRC_NAME	Database short name</span>
    <span class="c1"># EBS SRC_ORIGIN_NAME	Database schema name	exemple :</span>
    <span class="c1"># APPS SRC_OBJECT_NAME	Table name	example GL_PERIODS</span>
    <span class="c1"># SRC_OBJECT_CONSTRAINT	where clause for filtering data</span>
    <span class="c1"># SRC_FLAG_INCR : integrate date in incremental mode, based on date lastupdate</span>
    <span class="c1"># SRC_date_where : clause where to filter on records date, might depend on table</span>
    <span class="c1"># SRC_date_lastupdate : update last timestamp for data integration</span>
    <span class="c1"># FORCE_ENCODE : if UnicodeError during fetch, custom select by converting column of type VARCHAR to a specific CHARSET</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_source_properties</span><span class="p">:</span><span class="n">SourceProperties</span><span class="p">,</span> <span class="n">p_bronze_config</span><span class="p">:</span><span class="n">BronzeConfig</span><span class="p">,</span> <span class="n">p_bronzeDb_Manager</span><span class="p">:</span><span class="n">BronzeDbManager</span><span class="p">,</span><span class="n">p_logger</span><span class="p">:</span><span class="n">BronzeLogger</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bronze_source_properties</span> <span class="o">=</span> <span class="n">p_source_properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bronze_config</span> <span class="o">=</span> <span class="n">p_bronze_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bronzedb_manager</span> <span class="o">=</span> <span class="n">p_bronzeDb_Manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronze_config</span><span class="o">.</span><span class="n">get_options</span><span class="p">()</span><span class="o">.</span><span class="n">environment</span>

        <span class="c1"># Create &quot;tmp&quot; folder to save parquet files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__set_local_workgingdir__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bronze_config</span><span class="o">.</span><span class="n">get_tempdir</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df_table_content</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="c1"># list of parquet file generated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parquet_file_list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># format list : [{&quot;file_name&quot;:parquet_file_name1,&quot;source_file&quot;:source_file1},{&quot;file_name&quot;:parquet_file_name2,&quot;source_file&quot;:source_file2},...]</span>
        <span class="c1"># list of parquet file to send</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parquet_file_list_tosend</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># # format list : [{&quot;file_name&quot;:parquet_file_name1,&quot;source_file&quot;:source_file1},{&quot;file_name&quot;:parquet_file_name2,&quot;source_file&quot;:source_file2},...]</span>
        <span class="c1"># sent parquet files to OCI bucket</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bucket_list_parquet_files_sent</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Format the timestamp as a string with a specific format (Year-Month-Day)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">externaltablepartition</span> <span class="o">=</span> <span class="n">ExternalTablePartitionsProperties</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">today</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y&quot;</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">today</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m&quot;</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">today</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">))</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        self.year = self.today.strftime(&quot;%Y&quot;)</span>
<span class="sd">        self.month = self.today.strftime(&quot;%Y%m&quot;)</span>
<span class="sd">        self.day = self.today.strftime(&quot;%Y%m%d&quot;)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bucket_file_path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="c1"># defined into sub-class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bronze_table</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="c1"># defined into sub-class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bronze_schema</span> <span class="o">=</span> <span class="n">p_bronzeDb_Manager</span><span class="o">.</span><span class="n">get_db_username</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bronze_status</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Date of last update row</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bronze_date_lastupdated_row</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">total_sent_parquets</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Total number of parquet files sent to bucket</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_sent_parquets_size</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># total size of parquet files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_temp_parquets</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># total of temporary parquets created when fetching data, before merging for no incremental table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_imported_rows</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Total number of rows imported from the source table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_imported_rows_size</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># size of importted rows from source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fetch_start</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">upload_parquets_start</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_duration</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="c1"># duration of requests</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fetch_duration</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="c1"># duration to ftech data and create local parquet files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">upload_parquets_duration</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="c1"># duration to send parquet files to OCI</span>
        <span class="c1"># if debug = True then we use a dedicated bucket to store parquet files. Bucket name identified into json config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronze_config</span><span class="o">.</span><span class="n">isdebugmode</span><span class="p">()</span>

        <span class="c1"># set bronze bucket settings </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bronze_bucket_proxy</span> <span class="o">=</span> <span class="n">BronzeBucketProxy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bronze_config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__set_bronze_bucket_proxy__</span><span class="p">()</span>
         
        <span class="c1"># To be set into subclass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_db</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_db_connection</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_table_indexes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronze_source_properties</span><span class="o">.</span><span class="n">source_table_indexes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bronze_bis_pk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronze_source_properties</span><span class="o">.</span><span class="n">bronze_bis_pk</span>

        <span class="c1"># For DB source, build select request</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">where</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_execute_bind</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronze_source_properties</span><span class="o">.</span><span class="n">table_constraint</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">where</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronze_source_properties</span><span class="o">.</span><span class="n">table_constraint</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronze_source_properties</span><span class="o">.</span><span class="n">date_criteria</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronze_source_properties</span><span class="o">.</span><span class="n">last_update</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">where</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">where</span> <span class="o">+=</span> <span class="s2">&quot; AND &quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">where</span> <span class="o">+=</span> <span class="s2">&quot; WHERE &quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">where</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronze_source_properties</span><span class="o">.</span><span class="n">date_criteria</span> <span class="o">+</span> <span class="s2">&quot; &gt; :1&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_execute_bind</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bronze_source_properties</span><span class="o">.</span><span class="n">last_update</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># Set Bronze table settings : table name, bucket path to add parquet files, get index to restart parquet files interation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__set_bronze_table_settings__</span><span class="p">()</span>
        
        <span class="c1"># setup logger to log events errors and COMPLETED into LOG_ table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">p_logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">link_to_bronze_source</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    
<div class="viewcode-block" id="BronzeSourceBuilder.set_bronzedb_connection">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeSourceBuilder.set_bronzedb_connection">[docs]</a>
    <span class="k">def</span> <span class="nf">set_bronzedb_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pBronzeDbManager</span><span class="p">:</span><span class="n">BronzeDbManager</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bronzedb_manager</span> <span class="o">=</span> <span class="n">pBronzeDbManager</span></div>

        
<div class="viewcode-block" id="BronzeSourceBuilder.update_total_duration">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeSourceBuilder.update_total_duration">[docs]</a>
    <span class="k">def</span> <span class="nf">update_total_duration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_duration</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span> </div>


<div class="viewcode-block" id="BronzeSourceBuilder.get_bronze_config">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeSourceBuilder.get_bronze_config">[docs]</a>
    <span class="k">def</span> <span class="nf">get_bronze_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronze_config</span></div>


<div class="viewcode-block" id="BronzeSourceBuilder.get_bronzedb_manager">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeSourceBuilder.get_bronzedb_manager">[docs]</a>
    <span class="k">def</span> <span class="nf">get_bronzedb_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronzedb_manager</span></div>

    
<div class="viewcode-block" id="BronzeSourceBuilder.get_post_procedure_parameters">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeSourceBuilder.get_post_procedure_parameters">[docs]</a>
    <span class="k">def</span> <span class="nf">get_post_procedure_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronze_source_properties</span><span class="o">.</span><span class="n">bronze_post_proc</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bronze_source_properties</span><span class="o">.</span><span class="n">bronze_post_proc</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bronze_source_properties</span><span class="o">.</span><span class="n">bronze_post_proc_args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

    
<div class="viewcode-block" id="BronzeSourceBuilder.get_rows_stats">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeSourceBuilder.get_rows_stats">[docs]</a>
    <span class="k">def</span> <span class="nf">get_rows_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_imported_rows</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_imported_rows_size</span><span class="p">)</span></div>


<div class="viewcode-block" id="BronzeSourceBuilder.get_durations_stats">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeSourceBuilder.get_durations_stats">[docs]</a>
    <span class="k">def</span> <span class="nf">get_durations_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_duration</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">fetch_duration</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">upload_parquets_duration</span><span class="p">)</span></div>


<div class="viewcode-block" id="BronzeSourceBuilder.get_parquets_stats">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeSourceBuilder.get_parquets_stats">[docs]</a>
    <span class="k">def</span> <span class="nf">get_parquets_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_sent_parquets</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_sent_parquets_size</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">total_temp_parquets</span><span class="p">)</span></div>


<div class="viewcode-block" id="BronzeSourceBuilder.get_bronze_source_properties">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeSourceBuilder.get_bronze_source_properties">[docs]</a>
    <span class="k">def</span> <span class="nf">get_bronze_source_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronze_source_properties</span></div>


<div class="viewcode-block" id="BronzeSourceBuilder.get_bronze_properties">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeSourceBuilder.get_bronze_properties">[docs]</a>
    <span class="k">def</span> <span class="nf">get_bronze_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">BronzeProperties</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bronze_schema</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bronze_table</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bronze_bucket_proxy</span><span class="o">.</span><span class="n">get_bucket_name</span><span class="p">(),</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket_file_path</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">parquet_file_name_template</span><span class="p">)</span></div>


<div class="viewcode-block" id="BronzeSourceBuilder.get_externaltablepartition_properties">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeSourceBuilder.get_externaltablepartition_properties">[docs]</a>
    <span class="k">def</span> <span class="nf">get_externaltablepartition_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">externaltablepartition</span></div>

    
<div class="viewcode-block" id="BronzeSourceBuilder.get_logger">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeSourceBuilder.get_logger">[docs]</a>
    <span class="k">def</span> <span class="nf">get_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span></div>


<div class="viewcode-block" id="BronzeSourceBuilder.get_bronze_status">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeSourceBuilder.get_bronze_status">[docs]</a>
    <span class="k">def</span> <span class="nf">get_bronze_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronze_status</span></div>

    
<div class="viewcode-block" id="BronzeSourceBuilder.set_bronze_status">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeSourceBuilder.set_bronze_status">[docs]</a>
    <span class="k">def</span> <span class="nf">set_bronze_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">step</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bronze_status</span> <span class="o">=</span> <span class="n">DICT_STATUS_CODE</span><span class="p">[</span><span class="n">step</span><span class="p">]</span></div>

        
<div class="viewcode-block" id="BronzeSourceBuilder.get_bronze_bucket_settings">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeSourceBuilder.get_bronze_bucket_settings">[docs]</a>
    <span class="k">def</span> <span class="nf">get_bronze_bucket_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronze_bucket_settings</span></div>

    
<div class="viewcode-block" id="BronzeSourceBuilder.get_bucket_parquet_files_sent">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeSourceBuilder.get_bucket_parquet_files_sent">[docs]</a>
    <span class="k">def</span> <span class="nf">get_bucket_parquet_files_sent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bucket_list_parquet_files_sent</span></div>

        
<div class="viewcode-block" id="BronzeSourceBuilder.get_bronze_row_lastupdate_date">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeSourceBuilder.get_bronze_row_lastupdate_date">[docs]</a>
    <span class="k">def</span> <span class="nf">get_bronze_row_lastupdate_date</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="BronzeSourceBuilder.get_source_table_indexes">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeSourceBuilder.get_source_table_indexes">[docs]</a>
    <span class="k">def</span> <span class="nf">get_source_table_indexes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Get source table indexes if not already defined </span>
        <span class="k">return</span> <span class="kc">None</span></div>

    
<div class="viewcode-block" id="BronzeSourceBuilder.get_bronze_bis_pk">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeSourceBuilder.get_bronze_bis_pk">[docs]</a>
    <span class="k">def</span> <span class="nf">get_bronze_bis_pk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># list columns of primary key based on source table indexes : search for unique index</span>
        <span class="c1">#  unique index name ends with _U{digit} or _PK</span>
        <span class="k">return</span> <span class="kc">None</span></div>

    
<div class="viewcode-block" id="BronzeSourceBuilder.isexternalpartionedtable">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeSourceBuilder.isexternalpartionedtable">[docs]</a>
    <span class="k">def</span> <span class="nf">isexternalpartionedtable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronze_source_properties</span><span class="o">.</span><span class="n">incremental</span></div>

    
    <span class="k">def</span> <span class="nf">__set_local_workgingdir__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="c1"># Create a temporary directory if it doesn&#39;t exist</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_workingdir</span> <span class="o">=</span> <span class="n">path</span>
    
    <span class="k">def</span> <span class="nf">__update_fetch_row_stats__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_imported_rows</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_table_content</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_imported_rows_size</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_table_content</span><span class="o">.</span><span class="n">memory_usage</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_start</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fetch_duration</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_start</span>

    <span class="k">def</span> <span class="nf">__update_sent_parquets_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_temp_parquets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parquet_file_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_sent_parquets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parquet_file_list_tosend</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parquet_file_list_tosend</span><span class="p">:</span>
            <span class="n">source_file</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;source_file&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">total_sent_parquets_size</span> <span class="o">+=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">source_file</span><span class="p">)</span>
            <span class="c1"># Deleting temp file</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">source_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">upload_parquets_start</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">upload_parquets_duration</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">upload_parquets_start</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">upload_parquets_start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__add_integration_date_column__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Adding column into every parquet file with System date to log integration datetime</span>
        <span class="n">v_integration_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_table_content</span><span class="p">[</span><span class="s2">&quot;fetch_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_integration_time</span>
        <span class="c1"># adding column FETCH_YEAR, FETCH_MONTH, FETCH_DAY for not external partioned table</span>
        <span class="c1"># for this table, the columns are created automatically : columns = subfoler of bucket storage of parquet files</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isexternalpartionedtable</span><span class="p">():</span>
            <span class="n">v_dict_join</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_externaltablepartition_properties</span><span class="p">()</span><span class="o">.</span><span class="n">_asdict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">v_key</span><span class="p">,</span><span class="n">v_value</span> <span class="ow">in</span> <span class="n">v_dict_join</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df_table_content</span><span class="p">[</span><span class="n">INVERTED_EXTERNAL_TABLE_PARTITION_SYNONYMS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">v_key</span><span class="p">,</span><span class="n">v_key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">v_value</span>
       

    <span class="k">def</span> <span class="nf">__get_last_parquet_idx_in_bucket__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># check if other parquet files already exist into the same bucket folder</span>
        <span class="c1"># get the last id parquet number</span>
        <span class="c1"># to avoid remplace existing parquet files</span>
        <span class="n">v_idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1">#bucket = FILESTORAGEFACTORY.create_instance(self.get_bronze_bucket_settings().filestorage_wrapper,**self.get_bronze_bucket_settings()._asdict())</span>
            <span class="n">v_bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronze_bucket_proxy</span><span class="o">.</span><span class="n">get_bucket</span><span class="p">()</span>
            <span class="n">v_what_to_search</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bucket_file_path</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">parquet_file_name_template</span>
            <span class="n">v_filter_bucket_func</span> <span class="o">=</span> <span class="n">build_fnmatch_filter</span><span class="p">(</span><span class="s1">&#39;*</span><span class="si">{}</span><span class="s1">*&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_what_to_search</span><span class="p">))</span>
            <span class="n">v_list_buckets_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">v_bucket</span><span class="o">.</span><span class="n">list_objects</span><span class="p">(</span><span class="n">v_filter_bucket_func</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">v_list_buckets_files</span><span class="p">:</span>
                <span class="n">v_max_file</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">v_list_buckets_files</span><span class="p">)</span>
                <span class="c1"># eliminate file extension</span>
                <span class="n">v_begin_file_name</span> <span class="o">=</span> <span class="n">v_max_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># span() returns a tuple containing the start-, and end positions of the match.</span>
                <span class="n">v_pos</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">v_what_to_search</span><span class="p">,</span> <span class="n">v_begin_file_name</span><span class="p">)</span><span class="o">.</span><span class="n">span</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">v_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">v_begin_file_name</span><span class="p">[</span><span class="n">v_pos</span><span class="p">:])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">v_idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">v_idx</span>

    <span class="k">def</span> <span class="nf">__set_bronze_bucket_proxy__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#define settings for bucket, especially storagename... could depends on subclass</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">__set_bronze_table_settings__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#define bronze table name, bucket path to add parquet files, get index to restart parquet files interation</span>
        <span class="k">pass</span>
        
    <span class="k">def</span> <span class="nf">__clean_temporary_parquet_files__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># clean temporay local parquet files (some could remain from previous failure process</span>
        <span class="n">merged_parquet_file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parquet_file_name_template</span> <span class="o">+</span> <span class="n">PARQUET_FILE_EXTENSION</span>
        <span class="n">merged_parquet_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_workingdir</span><span class="p">,</span> <span class="n">merged_parquet_file_name</span><span class="p">)</span>
        <span class="n">list_files</span> <span class="o">=</span> <span class="n">list_template_files</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">merged_parquet_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">list_files</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__create_parquet_file__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Parquet file si created locally into local_workingdir</span>
        <span class="c1"># Define the path and filename for the Parquet file, id on PARQUET_IDX_DIGITS digits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parquet_file_id</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">parquet_file_name</span><span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}{1}{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parquet_file_name_template</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parquet_file_id</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">PARQUET_IDX_DIGITS</span><span class="p">),</span><span class="n">PARQUET_FILE_EXTENSION</span><span class="p">)</span>
        <span class="n">source_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_workingdir</span><span class="p">,</span> <span class="n">parquet_file_name</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Create parquet file only if number of dataframe row &gt; 0</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_table_content</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1">#adding date of integration - new column into df</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__add_integration_date_column__</span><span class="p">()</span>
                <span class="c1"># Write the DataFrame to a Parquet file with the specified compression</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Creating parquet file </span><span class="si">{0}</span><span class="s2"> into local folder </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parquet_file_name</span><span class="p">,</span><span class="n">source_file</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="n">verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span><span class="s2">&quot;CREATE_PARQUET&quot;</span><span class="p">,</span><span class="s2">&quot;START&quot;</span><span class="p">,</span><span class="n">log_message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df_table_content</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">source_file</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;pyarrow&#39;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parquet_file_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;file_name&quot;</span><span class="p">:</span> <span class="n">parquet_file_name</span><span class="p">,</span> <span class="s2">&quot;source_file&quot;</span><span class="p">:</span> <span class="n">source_file</span><span class="p">})</span>
                <span class="c1">#print(&quot;parquet created&quot;)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;No row for </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parquet_file_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="n">verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;CREATE_PARQUET&quot;</span><span class="p">,</span> <span class="s2">&quot;START&quot;</span><span class="p">,</span> <span class="n">log_message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">vError</span> <span class="o">=</span> <span class="s2">&quot;ERROR Creating parquet file </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parquet_file_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;CREATE_PARQUET&quot;</span><span class="p">,</span> <span class="n">vError</span><span class="p">,</span><span class="n">log_message</span><span class="o">=</span><span class="s1">&#39;OS Error : &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pError</span><span class="o">=</span><span class="n">err</span><span class="p">,</span> <span class="n">pAction</span><span class="o">=</span><span class="n">vError</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">vError</span> <span class="o">=</span> <span class="s2">&quot;ERROR Creating parquet file </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parquet_file_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;CREATE_PARQUET&quot;</span><span class="p">,</span> <span class="n">vError</span><span class="p">,</span><span class="n">log_message</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pError</span><span class="o">=</span><span class="n">err</span><span class="p">,</span> <span class="n">pAction</span><span class="o">=</span><span class="n">vError</span><span class="p">)</span>
            <span class="c1"># continue can only be used within a loop, so we use pass instead</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">__custom_select_from_source__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># create select request from source</span>
        <span class="c1"># if need to encode columns, cast columns on select request</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_db</span><span class="p">:</span>
            <span class="n">full_table_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_db</span><span class="o">.</span><span class="n">get_full_table_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bronze_source_properties</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bronze_source_properties</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronze_source_properties</span><span class="o">.</span><span class="n">force_encode</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="s2">&quot;select * from &quot;</span> <span class="o">+</span> <span class="n">full_table_name</span> 
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_db_connection</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Error no DB connection&quot;</span><span class="p">)</span>
                <span class="p">(</span><span class="n">could_custom_select</span><span class="p">,</span><span class="n">custom_select_result</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_db</span><span class="o">.</span><span class="n">create_select_encode_from_table</span><span class="p">(</span><span class="n">full_table_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronze_source_properties</span><span class="o">.</span><span class="n">force_encode</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">could_custom_select</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">custom_select_result</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">custom_select_result</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">where</span> 

    <span class="k">def</span> <span class="nf">__sync_bronze_table__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronze_table</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bronzedb_manager</span><span class="p">()</span><span class="o">.</span><span class="n">get_db_connection</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Error no DB connection&quot;</span><span class="p">)</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bronzedb_manager</span><span class="p">()</span><span class="o">.</span><span class="n">get_db_connection</span><span class="p">()</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

            <span class="n">request</span> <span class="o">=</span> <span class="s1">&#39;BEGIN DBMS_CLOUD.SYNC_EXTERNAL_PART_TABLE(table_name =&gt;</span><span class="se">\&#39;</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">table</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">); END;&#39;</span>

            <span class="c1"># Execute a PL/SQL to synchronize Oracle partionned external table</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Synchronizing external partionned table </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
                <span class="n">verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;UPDATE_TABLE&quot;</span><span class="p">,</span> <span class="s2">&quot;SYNC&quot;</span><span class="p">,</span> <span class="n">log_message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="n">oracledb</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">vError</span> <span class="o">=</span> <span class="s2">&quot;ERROR Synchronizing table </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;SYNC_TABLE&quot;</span><span class="p">,</span> <span class="n">vError</span><span class="p">,</span> <span class="n">log_message</span><span class="o">=</span><span class="s1">&#39;Oracle DB error :</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pError</span><span class="o">=</span><span class="n">err</span><span class="p">,</span> <span class="n">pAction</span><span class="o">=</span><span class="n">vError</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">vError</span> <span class="o">=</span> <span class="s2">&quot;ERROR Synchronizing table </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;SYNC_TABLE&quot;</span><span class="p">,</span> <span class="n">vError</span><span class="p">,</span><span class="n">log_message</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pError</span><span class="o">=</span><span class="n">err</span><span class="p">,</span> <span class="n">pAction</span><span class="o">=</span><span class="n">vError</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">__create_bronze_table__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">vTable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronze_table</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bronzedb_manager</span><span class="p">()</span><span class="o">.</span><span class="n">get_db_connection</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Error no DB connection&quot;</span><span class="p">)</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bronzedb_manager</span><span class="p">()</span><span class="o">.</span><span class="n">get_db_connection</span><span class="p">()</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="c1"># Dropping table before recreating</span>
            <span class="c1">#drop = &#39;BEGIN EXECUTE IMMEDIATE \&#39;DROP TABLE &#39; + vTable + &#39;\&#39;; EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF; END;&#39;</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Dropping table </span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_bronzedb_manager</span><span class="p">()</span><span class="o">.</span><span class="n">get_db_username</span><span class="p">(),</span><span class="n">vTable</span><span class="p">)</span>
                <span class="n">verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;DROP_TABLE&quot;</span><span class="p">,</span> <span class="s2">&quot;START&quot;</span><span class="p">,</span> <span class="n">log_message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>
            <span class="c1">#cursor.execute(drop)</span>
            <span class="n">vResult_run_proc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bronzedb_manager</span><span class="p">()</span><span class="o">.</span><span class="n">run_proc</span><span class="p">(</span><span class="s1">&#39;LH2_BRONZE_ADMIN_PKG.DROP_TABLE_PROC&#39;</span><span class="p">,</span><span class="o">*</span><span class="p">[</span><span class="n">vTable</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bronze_config</span><span class="o">.</span><span class="n">get_options</span><span class="p">()</span><span class="o">.</span><span class="n">bronze_bis_suffixe</span><span class="p">],</span><span class="n">p_verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span><span class="n">p_proc_exe_context</span><span class="o">=</span><span class="n">vTable</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">vResult_run_proc</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ERROR dropping table </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vTable</span><span class="p">))</span>
            
            <span class="c1"># Create external part table parsing parquet files from bucket root (for incremental mode)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isexternalpartionedtable</span><span class="p">():</span>
                <span class="c1"># Create external part table parsing parquet files from bucket root (for incremental mode)</span>
                <span class="n">root_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bucket_file_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;/&quot;</span>
                <span class="n">create</span> <span class="o">=</span> <span class="s1">&#39;BEGIN DBMS_CLOUD.CREATE_EXTERNAL_PART_TABLE(table_name =&gt;</span><span class="se">\&#39;</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">vTable</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">,credential_name =&gt;</span><span class="se">\&#39;</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronze_bucket_proxy</span><span class="o">.</span><span class="n">get_oci_adw_credential</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">, file_uri_list =&gt;</span><span class="se">\&#39;</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronze_bucket_proxy</span><span class="o">.</span><span class="n">get_oci_objectstorage_url</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronze_bucket_proxy</span><span class="o">.</span><span class="n">get_bucket_name</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;/o/&#39;</span><span class="o">+</span><span class="n">root_path</span><span class="o">+</span><span class="s1">&#39;*&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">parquet_file_name_template</span> <span class="o">+</span> <span class="s1">&#39;*.parquet</span><span class="se">\&#39;</span><span class="s1">, format =&gt; </span><span class="se">\&#39;</span><span class="s1">{&quot;type&quot;:&quot;parquet&quot;, &quot;schema&quot;: &quot;first&quot;,&quot;partition_columns&quot;:[{&quot;name&quot;:&quot;fetch_year&quot;,&quot;type&quot;:&quot;varchar2(100)&quot;},{&quot;name&quot;:&quot;fetch_month&quot;,&quot;type&quot;:&quot;varchar2(100)&quot;},{&quot;name&quot;:&quot;fetch_day&quot;,&quot;type&quot;:&quot;varchar2(100)&quot;}]}</span><span class="se">\&#39;</span><span class="s1">); END;&#39;</span>
                <span class="c1"># create += &#39;EXECUTE IMMEDIATE &#39;+ &#39;\&#39;CREATE INDEX fetch_date ON &#39; + table + &#39;(fetch_year,fetch_month,fetch_date)\&#39;; END;&#39;</span>
                <span class="c1"># not supported for external table</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Create external table linked to ONE parquet file (for non incremental mode)</span>
                <span class="n">root_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bucket_file_path</span>
                <span class="n">create</span> <span class="o">=</span> <span class="s1">&#39;BEGIN DBMS_CLOUD.CREATE_EXTERNAL_TABLE(table_name =&gt;</span><span class="se">\&#39;</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">vTable</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">,credential_name =&gt;</span><span class="se">\&#39;</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronze_bucket_proxy</span><span class="o">.</span><span class="n">get_oci_adw_credential</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">, file_uri_list =&gt;</span><span class="se">\&#39;</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronze_bucket_proxy</span><span class="o">.</span><span class="n">get_oci_objectstorage_url</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronze_bucket_proxy</span><span class="o">.</span><span class="n">get_bucket_name</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;/o/&#39;</span> <span class="o">+</span> <span class="n">root_path</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">parquet_file_name_template</span> <span class="o">+</span> <span class="s1">&#39;.parquet</span><span class="se">\&#39;</span><span class="s1">, format =&gt; </span><span class="se">\&#39;</span><span class="s1">{&quot;type&quot;:&quot;parquet&quot;, &quot;schema&quot;: &quot;first&quot;}</span><span class="se">\&#39;</span><span class="s1">); END;&#39;</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Creating table </span><span class="si">{}</span><span class="s2"> : </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vTable</span><span class="p">,</span><span class="n">create</span><span class="p">)</span>
                <span class="n">verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;CREATE_TABLE&quot;</span><span class="p">,</span> <span class="s2">&quot;START&quot;</span><span class="p">,</span> <span class="n">log_message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">create</span><span class="p">)</span>
            <span class="c1"># Alter column type from BINARY_DOUBLE to NUMBER</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Altering table columns type </span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_bronzedb_manager</span><span class="p">()</span><span class="o">.</span><span class="n">get_db_username</span><span class="p">(),</span><span class="n">vTable</span><span class="p">)</span>
                <span class="n">verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;ALTER_TABLE&quot;</span><span class="p">,</span> <span class="s2">&quot;START&quot;</span><span class="p">,</span> <span class="n">log_message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>
            <span class="n">vResult_run_proc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bronzedb_manager</span><span class="p">()</span><span class="o">.</span><span class="n">run_proc</span><span class="p">(</span><span class="s1">&#39;LH2_BRONZE_ADMIN_PKG.ALTER_TABLE_COLUMN_TYPE_PROC&#39;</span><span class="p">,</span><span class="o">*</span><span class="p">[</span><span class="n">vTable</span><span class="p">,</span><span class="s1">&#39;BINARY_DOUBLE&#39;</span><span class="p">,</span><span class="s1">&#39;NUMBER(38,10)&#39;</span><span class="p">],</span><span class="n">p_verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span><span class="n">p_proc_exe_context</span><span class="o">=</span><span class="n">vTable</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">vResult_run_proc</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ERROR altering table columns type </span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_bronzedb_manager</span><span class="p">()</span><span class="o">.</span><span class="n">get_db_username</span><span class="p">(),</span><span class="n">vTable</span><span class="p">))</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="n">oracledb</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">vError</span><span class="o">=</span> <span class="s2">&quot;ERROR Creating table </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vTable</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;CREATE_TABLE&quot;</span><span class="p">,</span> <span class="n">vError</span><span class="p">,</span><span class="n">log_message</span><span class="o">=</span><span class="s1">&#39;Oracle DB error : </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pError</span><span class="o">=</span><span class="n">err</span><span class="p">,</span> <span class="n">pAction</span><span class="o">=</span><span class="n">vError</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">vError</span> <span class="o">=</span> <span class="s2">&quot;ERROR Creating table </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vTable</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;CREATE_TABLE&quot;</span><span class="p">,</span> <span class="n">vError</span><span class="p">,</span><span class="n">log_message</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pError</span><span class="o">=</span><span class="n">err</span><span class="p">,</span> <span class="n">pAction</span><span class="o">=</span><span class="n">vError</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

    
<div class="viewcode-block" id="BronzeSourceBuilder.send_parquet_files_to_oci">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeSourceBuilder.send_parquet_files_to_oci">[docs]</a>
    <span class="k">def</span> <span class="nf">send_parquet_files_to_oci</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">upload_parquets_start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__update_sent_parquets_stats</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parquet_file_list</span><span class="p">:</span>
            <span class="n">vError</span> <span class="o">=</span> <span class="s2">&quot;WARNING, No parquet files to upload&quot;</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;UPLOAD_PARQUET&quot;</span><span class="p">,</span> <span class="n">vError</span><span class="p">,</span> <span class="n">log_message</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pError</span><span class="o">=</span><span class="ne">Exception</span><span class="p">(</span><span class="n">vError</span><span class="p">),</span> <span class="n">pAction</span><span class="o">=</span><span class="n">vError</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_bronze_status</span><span class="p">(</span><span class="s1">&#39;parquet_sent&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parquet_file_list_tosend</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isexternalpartionedtable</span><span class="p">():</span>
            <span class="c1"># if not incremental mode, merging parquet files into one, before sending</span>
            <span class="n">merged_parquet_file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parquet_file_name_template</span><span class="o">+</span><span class="n">PARQUET_FILE_EXTENSION</span>
            <span class="n">merged_parquet_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_workingdir</span><span class="p">,</span> <span class="n">merged_parquet_file_name</span><span class="p">)</span>
            <span class="c1"># Use 1st alternative to merge parquet files</span>
            <span class="c1">#parquet_files_tomerge = [p[&quot;source_file&quot;] for p in self.parquet_file_list]</span>
            <span class="c1">#merge_parquet_files(parquet_files_tomerge,merged_parquet_file,removesource=True,self.verbose)</span>
            <span class="c1">#########################</span>
            <span class="c1"># Use 2nd alternative to merge parquet file based on same root names - based on duckdb</span>
            <span class="n">duckdb_db</span> <span class="o">=</span> <span class="n">DBFACTORY</span><span class="o">.</span><span class="n">create_instance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bronze_config</span><span class="o">.</span><span class="n">get_duckdb_settings</span><span class="p">()</span><span class="o">.</span><span class="n">dbwrapper</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bronze_config</span><span class="o">.</span><span class="n">get_configuration_file</span><span class="p">())</span>
            <span class="n">duckdb_db_connection</span> <span class="o">=</span> <span class="n">duckdb_db</span><span class="o">.</span><span class="n">create_db_connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bronze_config</span><span class="o">.</span><span class="n">get_duckdb_settings</span><span class="p">())</span>
            <span class="n">merge_template_parquet_files</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">merged_parquet_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="n">duckdb_db_connection</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">verbose</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">parquet_file_list_tosend</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;source_file&quot;</span><span class="p">:</span><span class="n">merged_parquet_file</span><span class="p">,</span><span class="s2">&quot;file_name&quot;</span><span class="p">:</span><span class="n">merged_parquet_file_name</span><span class="p">}]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parquet_file_list_tosend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parquet_file_list</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1">#bucket = FILESTORAGEFACTORY.create_instance(self.get_bronze_bucket_settings().filestorage_wrapper,**self.get_bronze_bucket_settings()._asdict())</span>
            <span class="n">bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bronze_bucket_proxy</span><span class="o">.</span><span class="n">get_bucket</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__update_sent_parquets_stats</span><span class="p">()</span>
            <span class="n">vError</span> <span class="o">=</span> <span class="s2">&quot;ERROR create access to bucket </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bronze_bucket_proxy</span><span class="o">.</span><span class="n">get_bucket_name</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;BUCKET_ACCESS&quot;</span><span class="p">,</span> <span class="n">vError</span><span class="p">,</span> <span class="n">log_message</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pError</span><span class="o">=</span><span class="n">err</span><span class="p">,</span> <span class="n">pAction</span><span class="o">=</span><span class="n">vError</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>    
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parquet_file_list_tosend</span><span class="p">:</span>
                <span class="c1"># Sending parquet files</span>
                    <span class="n">bucket_file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bucket_file_path</span> <span class="o">+</span>  <span class="n">p</span><span class="p">[</span><span class="s2">&quot;file_name&quot;</span><span class="p">]</span>
                    <span class="n">source_file</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;source_file&quot;</span><span class="p">]</span>

                    <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Uploading parquet from </span><span class="si">{0}</span><span class="s2"> into bucket </span><span class="si">{1}</span><span class="s2">, </span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source_file</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bronze_bucket_proxy</span><span class="o">.</span><span class="n">get_bucket_name</span><span class="p">(),</span><span class="n">bucket_file_name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="n">verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span><span class="s2">&quot;UPLOAD_PARQUET&quot;</span><span class="p">,</span><span class="s2">&quot;START&quot;</span><span class="p">,</span><span class="n">log_message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>
                    <span class="n">bucket</span><span class="o">.</span><span class="n">put_file</span><span class="p">(</span><span class="n">bucket_file_name</span><span class="p">,</span> <span class="n">source_file</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bucket_list_parquet_files_sent</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bucket_file_name</span><span class="p">)</span> 
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__update_sent_parquets_stats</span><span class="p">()</span>
            <span class="n">vError</span> <span class="o">=</span> <span class="s2">&quot;ERROR Uplaoding parquet file </span><span class="si">{0}</span><span class="s2"> into bucket </span><span class="si">{1}</span><span class="s2">, </span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source_file</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bronze_bucket_proxy</span><span class="o">.</span><span class="n">get_bucket_name</span><span class="p">(),</span><span class="n">bucket_file_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;UPLOAD_PARQUET&quot;</span><span class="p">,</span> <span class="n">vError</span><span class="p">,</span> <span class="n">log_message</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pError</span><span class="o">=</span><span class="n">err</span><span class="p">,</span> <span class="n">pAction</span><span class="o">=</span><span class="n">vError</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__update_sent_parquets_stats</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_bronze_status</span><span class="p">(</span><span class="s1">&#39;parquet_sent&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="BronzeSourceBuilder.update_bronze_schema">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeSourceBuilder.update_bronze_schema">[docs]</a>
    <span class="k">def</span> <span class="nf">update_bronze_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">verbose</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Update Bronze schema </span><span class="si">{}</span><span class="s2"> : External Partioned Table </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bronze_table</span><span class="p">,</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">isexternalpartionedtable</span><span class="p">()))</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;UPADATE_BRONZE&quot;</span><span class="p">,</span> <span class="s2">&quot;START&quot;</span><span class="p">,</span> <span class="n">log_message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parquet_file_list</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;No parquet files No update of Bronze needed&quot;</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="n">verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;UPADATE_BRONZE&quot;</span><span class="p">,</span> <span class="s2">&quot;END&quot;</span><span class="p">,</span> <span class="n">log_message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>
                <span class="n">res</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">isexternalpartionedtable</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bronzedb_manager</span><span class="p">()</span><span class="o">.</span><span class="n">is_table_exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bronze_table</span><span class="p">):</span>
                <span class="c1"># if incremental mode, if table exists, update (synchronize) external part table</span>
                <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sync_bronze_table__</span><span class="p">(</span><span class="n">verbose</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#if incremental mode,if table not exists,</span>
                <span class="c1">#create external part table linked to &quot;parquet_file_name_template&quot;xxx.parquets files from bucket root</span>
                <span class="c1"># if no incremental mode, drop existing table and recreate table linked to uploaded parquet file</span>
                <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__create_bronze_table__</span><span class="p">(</span><span class="n">verbose</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">res</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_bronze_status</span><span class="p">(</span><span class="s1">&#39;bronze_updated&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">vError</span> <span class="o">=</span> <span class="s2">&quot;ERROR Updating bronze schema, table : </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bronze_table</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;UPDATE_BRONZE_SCHEMA&quot;</span><span class="p">,</span> <span class="n">vError</span><span class="p">,</span><span class="n">log_message</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pError</span><span class="o">=</span><span class="n">err</span><span class="p">,</span> <span class="n">pAction</span><span class="o">=</span><span class="n">vError</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="BronzeSourceBuilder.pre_fetch_source">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeSourceBuilder.pre_fetch_source">[docs]</a>
    <span class="k">def</span> <span class="nf">pre_fetch_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># TO BE EXECUTED before fetch method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_bronze_status</span><span class="p">(</span><span class="s1">&#39;fetching&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fetch_start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="c1">#delete old temporary parquet files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__clean_temporary_parquet_files__</span><span class="p">()</span></div>


<div class="viewcode-block" id="BronzeSourceBuilder.fetch_source">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeSourceBuilder.fetch_source">[docs]</a>
    <span class="k">def</span> <span class="nf">fetch_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Request data from source</span>
        <span class="c1"># and generate local parquet files</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="BronzeSourceBuilder.fetch_and_process">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeSourceBuilder.fetch_and_process">[docs]</a>
    <span class="k">def</span> <span class="nf">fetch_and_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">v_rest_fetch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_source</span><span class="p">(</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v_rest_fetch</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_bronze_status</span><span class="p">(</span><span class="s1">&#39;data_fetched&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v_rest_fetch</span></div>
</div>

    
<div class="viewcode-block" id="BronzeGenerator">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeGenerator">[docs]</a>
<span class="k">class</span> <span class="nc">BronzeGenerator</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pBronzeSourceBuilder</span><span class="p">:</span><span class="n">BronzeSourceBuilder</span><span class="p">,</span> <span class="n">pBronzeExploit</span><span class="p">:</span><span class="n">BronzeExploit</span><span class="p">,</span><span class="n">pLogger</span><span class="p">:</span><span class="n">BronzeLogger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v_bronzesourcebuilder</span> <span class="o">=</span> <span class="n">pBronzeSourceBuilder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v_bronzeexploit</span> <span class="o">=</span> <span class="n">pBronzeExploit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v_logger</span> <span class="o">=</span> <span class="n">pLogger</span>

<div class="viewcode-block" id="BronzeGenerator.generate">
<a class="viewcode-back" href="../../../nlsdata.oci_lh2_bronze.html#nlsdata.oci_lh2_bronze.oci_lh2_bronze.BronzeGenerator.generate">[docs]</a>
    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p_verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">v_generate_result</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">v_sourceProperties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_bronzesourcebuilder</span><span class="o">.</span><span class="n">get_bronze_source_properties</span><span class="p">()</span>
            <span class="n">v_dict_update_exploit</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                       
            <span class="c1"># 1 Fetch data from source</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">v_bronzesourcebuilder</span><span class="o">.</span><span class="n">pre_fetch_source</span><span class="p">(</span><span class="n">p_verbose</span><span class="p">)</span>
            <span class="c1">#### update exploit table with status of generator</span>
            <span class="n">v_dict_update_exploit</span><span class="p">[</span><span class="s1">&#39;bronze_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_bronzesourcebuilder</span><span class="o">.</span><span class="n">get_bronze_status</span><span class="p">()</span> 
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_bronzeexploit</span><span class="o">.</span><span class="n">update_exploit</span><span class="p">(</span><span class="n">v_dict_update_exploit</span><span class="p">,</span><span class="n">p_source</span><span class="o">=</span><span class="n">v_sourceProperties</span><span class="p">):</span>
                <span class="k">break</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_bronzesourcebuilder</span><span class="o">.</span><span class="n">fetch_and_process</span><span class="p">(</span><span class="n">p_verbose</span><span class="p">):</span>
                <span class="k">break</span>
            <span class="c1">#### update exploit table with status of generator</span>
            <span class="n">v_dict_update_exploit</span><span class="p">[</span><span class="s1">&#39;bronze_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_bronzesourcebuilder</span><span class="o">.</span><span class="n">get_bronze_status</span><span class="p">()</span> 
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_bronzeexploit</span><span class="o">.</span><span class="n">update_exploit</span><span class="p">(</span><span class="n">v_dict_update_exploit</span><span class="p">,</span><span class="n">p_source</span><span class="o">=</span><span class="n">v_sourceProperties</span><span class="p">):</span>
                <span class="k">break</span>
            
            <span class="c1"># 2 Upload parquets files to bucket</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_bronzesourcebuilder</span><span class="o">.</span><span class="n">send_parquet_files_to_oci</span><span class="p">(</span><span class="n">p_verbose</span><span class="p">):</span>
                <span class="k">break</span>
            <span class="n">v_dict_update_exploit</span><span class="p">[</span><span class="s1">&#39;bronze_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_bronzesourcebuilder</span><span class="o">.</span><span class="n">get_bronze_status</span><span class="p">()</span> 
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_bronzeexploit</span><span class="o">.</span><span class="n">update_exploit</span><span class="p">(</span><span class="n">v_dict_update_exploit</span><span class="p">,</span><span class="n">p_source</span><span class="o">=</span><span class="n">v_sourceProperties</span><span class="p">):</span>
                <span class="k">break</span>
            
            <span class="c1"># 3 - Create/Update external table into Autonomous</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_bronzesourcebuilder</span><span class="o">.</span><span class="n">update_bronze_schema</span><span class="p">(</span><span class="n">p_verbose</span><span class="p">):</span>
                <span class="k">break</span>
            <span class="n">v_dict_update_exploit</span><span class="p">[</span><span class="s1">&#39;bronze_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_bronzesourcebuilder</span><span class="o">.</span><span class="n">get_bronze_status</span><span class="p">()</span> 
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_bronzeexploit</span><span class="o">.</span><span class="n">update_exploit</span><span class="p">(</span><span class="n">v_dict_update_exploit</span><span class="p">,</span><span class="n">p_source</span><span class="o">=</span><span class="n">v_sourceProperties</span><span class="p">):</span>
                <span class="k">break</span>
            
            <span class="c1"># 4 Update &quot;last parquet file uploaded&quot;, source table index columns, &quot;Last_update&quot; for incremental table integration</span>
            <span class="k">if</span> <span class="n">p_verbose</span><span class="p">:</span>
                <span class="c1">#print(vSourceProperties)</span>
                <span class="n">v_message</span> <span class="o">=</span> <span class="s2">&quot;Update Exploit table for </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_sourceProperties</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">v_sourceProperties</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span><span class="n">v_sourceProperties</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>
                <span class="n">p_verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;INTEGRATE&quot;</span><span class="p">,</span> <span class="s2">&quot;RUNNING&quot;</span><span class="p">,</span> <span class="n">log_message</span><span class="o">=</span><span class="n">v_message</span><span class="p">)</span>
            
            <span class="c1"># Get bronze table name to update Exploit loading table</span>
            <span class="n">v_dict_update_exploit</span><span class="p">[</span><span class="s1">&#39;bronze_table_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_bronzesourcebuilder</span><span class="o">.</span><span class="n">get_bronze_properties</span><span class="p">()</span><span class="o">.</span><span class="n">table</span>
             <span class="c1"># Get last uploaded parquet file to update Exploit loading table</span>
            <span class="n">v_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_bronzesourcebuilder</span><span class="o">.</span><span class="n">get_bucket_parquet_files_sent</span><span class="p">()</span>
            <span class="n">v_last_bucket_parquet_file_sent</span> <span class="o">=</span> <span class="n">v_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">v_list</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">v_dict_update_exploit</span><span class="p">[</span><span class="s1">&#39;lastuploaded_parquet&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_last_bucket_parquet_file_sent</span>
            <span class="c1">#Get indexes of source table</span>
            <span class="n">v_dict_update_exploit</span><span class="p">[</span><span class="s1">&#39;source_table_indexes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_bronzesourcebuilder</span><span class="o">.</span><span class="n">get_source_table_indexes</span><span class="p">()</span>
             <span class="c1"># if incremental integration, get lastupdate date to update Exploit loading table and build bronze bis merge join            </span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_bronzesourcebuilder</span><span class="o">.</span><span class="n">isexternalpartionedtable</span><span class="p">():</span>
                <span class="n">v_lastupdate_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_bronzesourcebuilder</span><span class="o">.</span><span class="n">get_bronze_row_lastupdate_date</span><span class="p">()</span>
                <span class="n">v_bronze_bis_pk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_bronzesourcebuilder</span><span class="o">.</span><span class="n">get_bronze_bis_pk</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">v_lastupdate_date</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">v_bronze_bis_pk</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">v_lastupdate_date</span><span class="p">:</span>
                <span class="n">v_dict_update_exploit</span><span class="p">[</span><span class="s1">&#39;last_update&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_lastupdate_date</span>
            <span class="k">if</span> <span class="n">v_bronze_bis_pk</span><span class="p">:</span>
                <span class="n">v_dict_update_exploit</span><span class="p">[</span><span class="s1">&#39;bronze_bis_pk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_bronze_bis_pk</span>
            <span class="c1"># Set date when bronze table has been updated</span>
            <span class="n">v_dict_update_exploit</span><span class="p">[</span><span class="s1">&#39;bronze_update&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">v_bronzesourcebuilder</span><span class="o">.</span><span class="n">set_bronze_status</span><span class="p">(</span><span class="s1">&#39;completed&#39;</span><span class="p">)</span>
            <span class="n">v_dict_update_exploit</span><span class="p">[</span><span class="s1">&#39;bronze_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_bronzesourcebuilder</span><span class="o">.</span><span class="n">get_bronze_status</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_bronzeexploit</span><span class="o">.</span><span class="n">update_exploit</span><span class="p">(</span><span class="n">v_dict_update_exploit</span><span class="p">,</span><span class="n">p_source</span><span class="o">=</span><span class="n">v_sourceProperties</span><span class="p">):</span>
                <span class="k">break</span>
            <span class="c1"># Run Post integration PLSQL procedure for current source</span>
            <span class="n">v_post_proc_param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_bronzesourcebuilder</span><span class="o">.</span><span class="n">get_post_procedure_parameters</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">v_post_proc_param</span><span class="p">:</span>
                <span class="n">v_bronze_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_bronzesourcebuilder</span><span class="o">.</span><span class="n">get_bronze_properties</span><span class="p">()</span><span class="o">.</span><span class="n">table</span>
                <span class="n">v_result_post_proc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_bronzesourcebuilder</span><span class="o">.</span><span class="n">get_bronzedb_manager</span><span class="p">()</span><span class="o">.</span><span class="n">run_proc</span><span class="p">(</span><span class="n">v_post_proc_param</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="o">*</span><span class="n">v_post_proc_param</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">p_verbose</span><span class="o">=</span><span class="n">p_verbose</span><span class="p">,</span><span class="n">p_proc_exe_context</span><span class="o">=</span><span class="n">v_bronze_table</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">v_result_post_proc</span><span class="p">:</span>
                    <span class="k">break</span>
            
            <span class="n">v_generate_result</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v_bronzesourcebuilder</span><span class="o">.</span><span class="n">update_total_duration</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">v_generate_result</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p_verbose</span><span class="p">:</span>
                <span class="c1">#print(vSourceProperties)</span>
                <span class="n">v_message</span> <span class="o">=</span> <span class="s2">&quot;Integrating </span><span class="si">{3}</span><span class="s2"> rows from </span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="s2"> </span><span class="si">{2}</span><span class="s2"> in </span><span class="si">{4}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v_sourceProperties</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">v_sourceProperties</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span>
                                                                         <span class="n">v_sourceProperties</span><span class="o">.</span><span class="n">table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_bronzesourcebuilder</span><span class="o">.</span><span class="n">get_rows_stats</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">v_bronzesourcebuilder</span><span class="o">.</span><span class="n">get_durations_stats</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">p_verbose</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span> <span class="s2">&quot;INTEGRATE&quot;</span><span class="p">,</span> <span class="s2">&quot;END&quot;</span><span class="p">,</span> <span class="n">log_message</span><span class="o">=</span><span class="n">v_message</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_logger</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">v_logger</span><span class="o">.</span><span class="n">log</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">v_generate_result</span></div>
</div>


</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">NLSDATA</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">nlsdata</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Code du module</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Recherche rapide</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2024, Ramjattan Keny.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.4.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
    </div>

    

    
  </body>
</html>